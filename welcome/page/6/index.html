<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/fsxl-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/sxl-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sxl2020.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="人惟患无志,有志无有不成者">
<meta property="og:type" content="website">
<meta property="og:title" content="苏小乐の主站">
<meta property="og:url" content="https://sxl2020.github.io/welcome/page/6/index.html">
<meta property="og:site_name" content="苏小乐の主站">
<meta property="og:description" content="人惟患无志,有志无有不成者">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="苏小乐">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sxl2020.github.io/welcome/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>苏小乐の主站</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苏小乐の主站</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">后端工程师</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-docs">

    <a href="/docs/" rel="section"><i class="fa fa-calendar fa-fw"></i>乐文档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/sxl2020" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-handle-exception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-handle-exception/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-使用-ControllerAdvice和-ExceptionHandler处理全局异常"><a href="#1-使用-ControllerAdvice和-ExceptionHandler处理全局异常" class="headerlink" title="1. 使用 @ControllerAdvice和@ExceptionHandler处理全局异常"></a>1. 使用 <strong>@ControllerAdvice和</strong>@ExceptionHandler处理全局异常</h3><p>这是目前很常用的一种方式，非常推荐。测试代码中用到了 Junit 5，如果你新建项目验证下面的代码的话，记得添加上相关依赖。</p>
<p><strong>1. 新建异常信息实体类</strong></p>
<p>非必要的类，主要用于包装异常信息。</p>
<p><code>src/main/java/com/twuc/webApp/exception/ErrorResponse.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> shuang.kou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> String errorTypeName;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponse</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(e.getClass().getName(), e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponse</span><span class="params">(String errorTypeName, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorTypeName = errorTypeName;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">    ......省略getter/setter方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. 自定义异常类型</strong></p>
<p><code>src/main/java/com/twuc/webApp/exception/ResourceNotFoundException.java</code></p>
<p>一般我们处理的都是 <code>RuntimeException</code> ，所以如果你需要自定义异常类型的话直接集成这个类就可以了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> shuang.kou</span></span><br><span class="line"><span class="comment"> * 自定义异常类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceNotFoundException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResourceNotFoundException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResourceNotFoundException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. 新建异常处理类</strong></p>
<p>我们只需要在类上加上<code>@ControllerAdvice</code>注解这个类就成为了全局异常处理类，当然你也可以通过 <code>assignableTypes </code>指定特定的 <code>Controller </code>类，让异常处理类只处理特定类抛出的异常。</p>
<p><code>src/main/java/com/twuc/webApp/exception/GlobalExceptionHandler.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> shuang.kou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice(assignableTypes = &#123;ExceptionController.class&#125;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ErrorResponse illegalArgumentResponse = <span class="keyword">new</span> ErrorResponse(<span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;参数错误!&quot;</span>));</span><br><span class="line">    ErrorResponse resourseNotFoundResponse = <span class="keyword">new</span> ErrorResponse(<span class="keyword">new</span> ResourceNotFoundException(<span class="string">&quot;Sorry, the resourse not found!&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span><span class="comment">// 拦截所有异常, 这里只是为了演示，一般情况下一个方法特定处理一种异常</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title">exceptionHandler</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IllegalArgumentException) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(<span class="number">400</span>).body(illegalArgumentResponse);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ResourceNotFoundException) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(<span class="number">404</span>).body(resourseNotFoundResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. controller模拟抛出异常</strong></p>
<p><code>src/main/java/com/twuc/webApp/web/ExceptionController.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> shuang.kou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/illegalArgumentException&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resourceNotFoundException&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwException2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ResourceNotFoundException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用  Get 请求 <a href="localhost:8333/api/resourceNotFoundException">localhost:8080/api/resourceNotFoundException</a> （curl -i -s -X GET url），服务端返回的 JSON 数据如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Sorry, the resourse not found!&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;errorTypeName&quot;</span>: <span class="string">&quot;com.twuc.webApp.exception.ResourceNotFoundException&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5. 编写测试类</strong> </p>
<p>MockMvc 由<code>org.springframework.boot.test</code>包提供，实现了对Http请求的模拟，一般用于我们测试  controller 层。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> shuang.kou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">should_return_400_if_param_not_valid</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/api/illegalArgumentException&quot;</span>))</span><br><span class="line">                .andExpect(status().is(<span class="number">400</span>))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.message&quot;</span>).value(<span class="string">&quot;参数错误!&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">should_return_404_if_resourse_not_found</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/api/resourceNotFoundException&quot;</span>))</span><br><span class="line">                .andExpect(status().is(<span class="number">404</span>))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.message&quot;</span>).value(<span class="string">&quot;Sorry, the resourse not found!&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-ExceptionHandler-处理-Controller-级别的异常"><a href="#2-ExceptionHandler-处理-Controller-级别的异常" class="headerlink" title="2. @ExceptionHandler 处理 Controller 级别的异常"></a>2. @ExceptionHandler 处理 Controller 级别的异常</h3><p>我们刚刚也说了使用<code>@ControllerAdvice</code>注解 可以通过 <code>assignableTypes </code>指定特定的类，让异常处理类只处理特定类抛出的异常。所以这种处理异常的方式，实际上现在使用的比较少了。</p>
<p> 我们把下面这段代码移到 <code>src/main/java/com/twuc/webApp/exception/GlobalExceptionHandler.java</code> 中就可以了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(value = Exception.class)</span><span class="comment">// 拦截所有异常</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title">exceptionHandler</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IllegalArgumentException) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(<span class="number">400</span>).body(illegalArgumentResponse);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ResourceNotFoundException) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(<span class="number">404</span>).body(resourseNotFoundResponse);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-ResponseStatusException"><a href="#3-ResponseStatusException" class="headerlink" title="3. ResponseStatusException"></a>3. ResponseStatusException</h3><p>研究 ResponseStatusException 我们先来看看，通过  <code>ResponseStatus</code>注解简单处理异常的方法（将异常映射为状态码）。</p>
<p><code>src/main/java/com/twuc/webApp/exception/ResourceNotFoundException.java</code></p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseStatus(code = HttpStatus.NOT_FOUND)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourseNotFoundException2</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResourseNotFoundException2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResourseNotFoundException2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>src/main/java/com/twuc/webApp/web/ResponseStatusExceptionController.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseStatusExceptionController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resourceNotFoundException2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwException3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ResourseNotFoundException2(<span class="string">&quot;Sorry, the resourse not found!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  使用  Get 请求 <a href="localhost:8333/api/resourceNotFoundException2">localhost:8080/api/resourceNotFoundException2</a> ，服务端返回的 JSON 数据如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-08-21T07:11:43.744+0000&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">404</span>,</span><br><span class="line">    <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;Not Found&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Sorry, the resourse not found!&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/api/resourceNotFoundException2&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种通过 <code>ResponseStatus</code>注解简单处理异常的方法是的好处是比较简单，但是一般我们不会这样做，通过<code>ResponseStatusException</code>会更加方便,可以避免我们额外的异常类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/resourceNotFoundException2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwException3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ResponseStatusException(HttpStatus.NOT_FOUND, <span class="string">&quot;Sorry, the resourse not found!&quot;</span>, <span class="keyword">new</span> ResourceNotFoundException());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  使用  Get 请求 <a href="localhost:8333/api/resourceNotFoundException2">localhost:8080/api/resourceNotFoundException2</a> ，服务端返回的 JSON 数据如下,和使用 <code>ResponseStatus</code>  实现的效果一样：</p>
 <figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-08-21T07:28:12.017+0000&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">404</span>,</span><br><span class="line">    <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;Not Found&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Sorry, the resourse not found!&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/api/resourceNotFoundException3&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ResponseStatusException</code> 提供了三个构造方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ResponseStatusException</span><span class="params">(HttpStatus status)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>(status, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ResponseStatusException</span><span class="params">(HttpStatus status, <span class="meta">@Nullable</span> String reason)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>(status, reason, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ResponseStatusException</span><span class="params">(HttpStatus status, <span class="meta">@Nullable</span> String reason, <span class="meta">@Nullable</span> Throwable cause)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(<span class="keyword">null</span>, cause);</span><br><span class="line">	Assert.notNull(status, <span class="string">&quot;HttpStatus is required&quot;</span>);</span><br><span class="line">	<span class="keyword">this</span>.status = status;</span><br><span class="line">	<span class="keyword">this</span>.reason = reason;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>构造函数中的参数解释如下：</p>
<ul>
<li>status ： http status</li>
<li>reason ：response 的消息内容</li>
<li>cause ： 抛出的异常</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文主要讲了 3 种捕获处理异常的方式：</p>
<ol>
<li>使用 <code>@ControllerAdvice</code> 和 <code>@ExceptionHandler</code> 处理全局异常</li>
<li><code>@ExceptionHandler</code> 处理 Controller 级别的异常</li>
<li><code>ResponseStatusException</code> </li>
</ol>
<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/source-code/basis/springboot-handle-exception">https://github.com/Snailclimb/springboot-guide/tree/master/source-code/basis/springboot-handle-exception</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/basis/@PostConstruct%E4%B8%8E@PreDestroy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/basis/@PostConstruct%E4%B8%8E@PreDestroy/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>@PostConstruct</code>和<code>@PreDestroy</code> 是两个作用于 Servlet 生命周期的注解，相信从 Servlet 开始学 Java 后台开发的同学对他应该不陌生。</p>
<p><strong>被这两个注解修饰的方法可以保证在整个 Servlet 生命周期只被执行一次，即使 Web 容器在其内部中多次实例化该方法所在的 bean。</strong></p>
<p><strong>这两个注解分别有什么作用呢</strong>？</p>
<ol>
<li><strong><code>@PostConstruct</code></strong> : 用来修饰方法，标记在项目启动的时候执行这个方法,一般用来执行某些初始化操作比如全局配置。<code>PostConstruct</code> 注解的方法会在构造函数之后执行,Servlet 的<code>init()</code>方法之前执行。</li>
<li><strong><code>@PreDestroy</code></strong> :  当 bean 被 Web 容器的时候被调用，一般用来释放 bean 所持有的资源。。<code>@PreDestroy</code> 注解的方法会在Servlet 的<code>destroy()</code>方法之前执行。</li>
</ol>
<p>被这个注解修饰的方法需要满足下面这些基本条件：</p>
<ul>
<li>非静态</li>
<li>该方法必须没有任何参数，除非在拦截器的情况下，在这种情况下，它接受一个由拦截器规范定义的InvocationContext对象</li>
<li>void()也就是没有返回值</li>
<li>该方法抛出未检查的异常</li>
<li>……</li>
</ul>
<p>我们新建一个 Spring 程序，其中有一段代码是这样的，输出结果会是什么呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造方法被调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;PostConstruct注解方法被调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;PreDestroy注解方法被调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/life-cycle-annotation01.jpg"></p>
<p>但是 J2EE已在Java 9中弃用 <code>@PostConstruct</code>和<code>@PreDestroy</code>这两个注解 ，并计划在Java 11中将其删除。我们有什么更好的替代方法吗？当然有！</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.javaguide.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.DisposableBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfiguration2</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyConfiguration2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造方法被调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterPropertiesSet方法被调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy方法被调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出结果如下，可以看出实现Spring 提供的  <code>InitializingBean</code>和 <code>DisposableBean</code>接口的效果和使用<code>@PostConstruct</code>和<code>@PreDestroy</code> 注解的效果一样。</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/life-cycle-annotation02.jpg"></p>
<p>但是,Spring 官方不推荐使用上面这种方式，<a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-factory-lifecycle">Spring 官方文档</a>是这样说的：</p>
<blockquote>
<p>We recommend that you do not use the <code>InitializingBean</code> interface, because it unnecessarily couples the code to Spring. Alternatively, we suggest using the <a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-postconstruct-and-predestroy-annotations"><code>@PostConstruct</code></a> annotation or specifying a POJO initialization method. (我们建议您不要使用 <code>InitializingBean</code>回调接口，因为它不必要地将代码耦合到 Spring。另外，我们建议使用<code>@PostConstruct</code>注解或指定bean定义支持的通用方法。)</p>
</blockquote>
<p>如果你还是非要使用 Java 9 及以后的版本使用 <code>@PostConstruct</code>和<code>@PreDestroy</code>  这两个注解的话，你也可以手动添加相关依赖。 </p>
<p>Maven:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Gradle:</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile <span class="attr">group:</span> <span class="string">&#x27;javax.annotation&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;javax.annotation-api&#x27;</span>, <span class="attr">version:</span> <span class="string">&#x27;1.3.2&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/source-code/basis/life-cycle-annotation">https://github.com/Snailclimb/springboot-guide/tree/master/source-code/basis/life-cycle-annotation</a></p>
</blockquote>
<p>推荐阅读：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://netjs.blogspot.com/2016/03/spring-bean-life-cycle.html">Spring Bean Life Cycle</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-oss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-oss/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>笔主很早就开始用阿里云OSS 存储服务当做自己的图床了。如果没有用过阿里云OSS 存储服务或者不是很了解这个东西的可以看看官方文档，我这里就不多做介绍了。阿里云对象存储 OSS文档，：</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/product/31815.html?spm=a2c4g.11186623.6.540.4e401c62EyJK5T">https://help.aliyun.com/product/31815.html?spm=a2c4g.11186623.6.540.4e401c62EyJK5T</a></p>
<p>本篇文章会介绍到 SpringBoot 整合阿里云OSS 存储服务实现文件上传下载以及简单的查看。其实今天讲的应该算的上是一个简单的小案例了，涉及到的知识点还算是比较多。相关代码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/springboot-oss">https://github.com/Snailclimb/springboot-guide/tree/master/springboot-oss</a> 。</p>
<!-- MarkdownTOC -->

<ul>
<li><a href="#%E4%B8%80-%E5%BC%80%E5%8F%91%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87">一 开发前的准备</a><ul>
<li><a href="#11-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86">1.1 前置知识</a></li>
<li><a href="#12-%E7%8E%AF%E5%A2%83%E5%8F%82%E6%95%B0">1.2 环境参数</a></li>
<li><a href="#13-%E4%BD%A0%E8%83%BD%E5%AD%A6%E5%88%B0%E4%BB%80%E4%B9%88">1.3 你能学到什么</a></li>
<li><a href="#14-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B">1.4 创建工程</a></li>
<li><a href="#15-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">1.5 项目结构</a></li>
<li><a href="#16-%E9%85%8D%E7%BD%AE-pom-%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96">1.6 配置 pom 文件中的相关依赖</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C-%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91-oss-%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7">二 配置阿里云 OSS 存储相关属性</a><ul>
<li><a href="#21-%E9%80%9A%E8%BF%87%E5%B8%B8%E9%87%8F%E7%B1%BB%E9%85%8D%E7%BD%AE%E6%9C%AC%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%B9%E5%BC%8F">2.1 通过常量类配置（本项目使用的方式）</a></li>
<li><a href="#22-%E9%80%9A%E8%BF%87properties-%E9%85%8D%E7%BD%AE">2.2  通过.properties 配置</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89-%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95%E7%BC%96%E5%86%99">三 工具类相关方法编写</a></li>
<li><a href="#%E5%9B%9B-controller-%E5%B1%82%E7%BC%96%E5%86%99%E7%9B%B8%E5%85%B3%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95">四 Controller 层编写相关测试方法</a></li>
<li><a href="#%E4%BA%94-%E5%90%AF%E5%8A%A8%E7%B1%BB">五 启动类</a></li>
<li><a href="#%E5%85%AD-%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E7%9B%B8%E5%85%B3%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2">六 上传图片相关前端页面</a></li>
<li><a href="#%E4%B8%83-%E6%B5%8B%E8%AF%95%E6%88%91%E4%BB%AC%E7%9A%84%E5%9B%BE%E5%BA%8A">七 测试我们的图床</a></li>
</ul>
<!-- /MarkdownTOC -->


<h2 id="一-开发前的准备"><a href="#一-开发前的准备" class="headerlink" title="一 开发前的准备"></a>一 开发前的准备</h2><h3 id="1-1-前置知识"><a href="#1-1-前置知识" class="headerlink" title="1.1 前置知识"></a>1.1 前置知识</h3><p>具有 Java 基础以及SpringBoot 简单基础知识即可。</p>
<h3 id="1-2-环境参数"><a href="#1-2-环境参数" class="headerlink" title="1.2 环境参数"></a>1.2 环境参数</h3><ul>
<li>开发工具：IDEA</li>
<li>基础工具：Maven+JDK8</li>
<li>所用技术：SpringBoot+阿里云OSS 存储服务 Java 相关API</li>
<li>SpringBoot版本：2.1.0</li>
</ul>
<h3 id="1-3-你能学到什么"><a href="#1-3-你能学到什么" class="headerlink" title="1.3 你能学到什么"></a>1.3 你能学到什么</h3><ul>
<li>SpringBoot 整合 阿里云OSS 存储服务并编写相关工具类</li>
<li>SpringBoot 整合 thymeleaf 并实现前后端传值</li>
<li>SpringBoot 从配置文件读取值并注入到类中</li>
<li>如何自己搭建一个图床使用（通过前端选择图片，支持预览，但不支持修改图片）</li>
</ul>
<h3 id="1-4-创建工程"><a href="#1-4-创建工程" class="headerlink" title="1.4 创建工程"></a>1.4 创建工程</h3><p>创建一个基本的 SpringBoot 项目，我这里就不多说这方面问题了，具体可以参考下面这篇文章：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34337272/article/details/79563606">https://blog.csdn.net/qq_34337272/article/details/79563606</a></p>
<h3 id="1-5-项目结构"><a href="#1-5-项目结构" class="headerlink" title="1.5 项目结构"></a>1.5 项目结构</h3><p><img src="http://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-12-4/75109079.jpg" alt="项目结构 "></p>
<h3 id="1-6-配置-pom-文件中的相关依赖"><a href="#1-6-配置-pom-文件中的相关依赖" class="headerlink" title="1.6 配置 pom 文件中的相关依赖"></a>1.6 配置 pom 文件中的相关依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Thymeleaf--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 阿里云OSS--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="二-配置阿里云-OSS-存储相关属性"><a href="#二-配置阿里云-OSS-存储相关属性" class="headerlink" title="二 配置阿里云 OSS 存储相关属性"></a>二 配置阿里云 OSS 存储相关属性</h2><p>我在项目中使用的通过常量类来配置，不过你也可以使用 .properties 配置文件来配置，然后<code>@ConfigurationProperties</code> 注解注入到类中。</p>
<h3 id="2-1-通过常量类配置（本项目使用的方式）"><a href="#2-1-通过常量类配置（本项目使用的方式）" class="headerlink" title="2.1 通过常量类配置（本项目使用的方式）"></a>2.1 通过常量类配置（本项目使用的方式）</h3><p>AliyunOSSConfigConstant.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: SnailClimb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2018/12/4 15:09</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 阿里云OSS存储的相关常量配置.我这里通过常量类来配置的，当然你也可以通过.properties 配置文件来配置，</span></span><br><span class="line"><span class="comment"> * 然后利用 SpringBoot 的<span class="doctag">@ConfigurationProperties</span> 注解来注入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliyunOSSConfigConstant</span> </span>&#123;</span><br><span class="line">    <span class="comment">//私有构造方法 禁止该类初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AliyunOSSConfigConstant</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//仓库名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUCKE_NAME = <span class="string">&quot;my-blog-to-use&quot;</span>;</span><br><span class="line">    <span class="comment">//地域节点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String END_POINT = <span class="string">&quot;oss-cn-beijing.aliyuncs.com&quot;</span>;</span><br><span class="line">    <span class="comment">//AccessKey ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AccessKey_ID = <span class="string">&quot;你的AccessKeyID&quot;</span>;</span><br><span class="line">    <span class="comment">//Access Key Secret</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AccessKey_Secret = <span class="string">&quot;你的AccessKeySecret&quot;</span>;</span><br><span class="line">    <span class="comment">//仓库中的某个文件夹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_HOST = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>到阿里云 OSS 控制台：<a target="_blank" rel="noopener" href="https://oss.console.aliyun.com/overview">https://oss.console.aliyun.com/overview</a>获取上述相关信息：</p>
<p>获取 BUCKE_NAME 和 END_POINT：</p>
<p><img src="http://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-12-4/62719967.jpg" alt="获取BUCKE_NAME和END_POINT"></p>
<p>获取AccessKey ID和Access Key Secret第一步：</p>
<p><img src="http://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-12-4/56702589.jpg" alt="获取AccessKey ID和Access Key Secret第一步"></p>
<p>获取AccessKey ID和Access Key Secret第二步：</p>
<p><img src="http://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-12-5/3395348.jpg" alt="获取AccessKey ID和Access Key Secret第二步"></p>
<h3 id="2-2-通过-properties-配置"><a href="#2-2-通过-properties-配置" class="headerlink" title="2.2  通过.properties 配置"></a>2.2  通过.properties 配置</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#OSS配置</span></span><br><span class="line"><span class="meta">aliyun.oss.bucketname</span>=<span class="string">my-blog-to-use</span></span><br><span class="line"><span class="meta">aliyun.oss.endpoint</span>=<span class="string">oss-cn-beijing.aliyuncs.com</span></span><br><span class="line"><span class="comment">#阿里云主账号AccessKey拥有所有API的访问权限，风险很高。建议创建并使用RAM账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建RAM账号。</span></span><br><span class="line"><span class="meta">aliyun.oss.keyid</span>=<span class="string">你的AccessKeyID</span></span><br><span class="line"><span class="meta">aliyun.oss.keysecret</span>=<span class="string">你的AccessKeySecret</span></span><br><span class="line"><span class="meta">aliyun.oss.filehost</span>=<span class="string">test</span></span><br></pre></td></tr></table></figure>

<p>然后新建一个类将属性注入：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource(value = &quot;classpath:application-oss.properties&quot;)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;aliyun.oss&quot;)</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阿里云oss的配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliyunOSSConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String bucketname;</span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="keyword">private</span> String keyid;</span><br><span class="line">    <span class="keyword">private</span> String keysecret;</span><br><span class="line">    <span class="keyword">private</span> String filehost;</span><br><span class="line">    ...</span><br><span class="line">    此处省略getter、setter以及 toString方法</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>


<h2 id="三-工具类相关方法编写"><a href="#三-工具类相关方法编写" class="headerlink" title="三 工具类相关方法编写"></a>三 工具类相关方法编写</h2><p>该工具类主要提供了三个方法：上传文件 <code>upLoad(File file) </code>、通过文件名下载文件<code>downloadFile(String objectName, String localFileName) </code>、列出某个文件夹下的所有文件<code>listFile( )</code>。笔主比较懒，代码可能还比较简陋，各位可以懂懂自己的脑子，参考阿里云官方提供的相关文档来根据自己的需求来优化。Java API文档地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/32008.html?spm=a2c4g.11186623.6.703.238374b4PsMzWf">https://help.aliyun.com/document_detail/32008.html?spm=a2c4g.11186623.6.703.238374b4PsMzWf</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: SnailClimb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2018/12/1 16:56</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 阿里云OSS服务相关工具类.</span></span><br><span class="line"><span class="comment"> * Java API文档地址：https://help.aliyun.com/document_detail/32008.html?spm=a2c4g.11186623.6.703.238374b4PsMzWf</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliyunOSSUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.Logger logger = LoggerFactory.getLogger(AliyunOSSUtil.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String FILE_URL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String bucketName = AliyunOSSConfigConstant.BUCKE_NAME;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String endpoint = AliyunOSSConfigConstant.END_POINT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String accessKeyId = AliyunOSSConfigConstant.AccessKey_ID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String accessKeySecret = AliyunOSSConfigConstant.AccessKey_Secret;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String fileHost = AliyunOSSConfigConstant.FILE_HOST;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file 需要上传的文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果上传的文件是图片的话，会返回图片的&quot;URL&quot;，如果非图片的话会返回&quot;非图片，不可预览。文件路径为：+文件路径&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">upLoad</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 默认值为：true</span></span><br><span class="line">        <span class="keyword">boolean</span> isImage = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 判断所要上传的图片是否是图片，图片可以预览，其他文件不提供通过URL预览</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Image image = ImageIO.read(file);</span><br><span class="line">            isImage = image == <span class="keyword">null</span> ? <span class="keyword">false</span> : <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;------OSS文件上传开始--------&quot;</span> + file.getName());</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        String dateStr = format.format(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断文件</span></span><br><span class="line">        <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        OSSClient ossClient = <span class="keyword">new</span> OSSClient(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 判断容器是否存在,不存在就创建</span></span><br><span class="line">            <span class="keyword">if</span> (!ossClient.doesBucketExist(bucketName)) &#123;</span><br><span class="line">                ossClient.createBucket(bucketName);</span><br><span class="line">                CreateBucketRequest createBucketRequest = <span class="keyword">new</span> CreateBucketRequest(bucketName);</span><br><span class="line">                createBucketRequest.setCannedACL(CannedAccessControlList.PublicRead);</span><br><span class="line">                ossClient.createBucket(createBucketRequest);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置文件路径和名称</span></span><br><span class="line">            String fileUrl = fileHost + <span class="string">&quot;/&quot;</span> + (dateStr + <span class="string">&quot;/&quot;</span> + UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;-&quot;</span> + file.getName());</span><br><span class="line">            <span class="keyword">if</span> (isImage) &#123;<span class="comment">//如果是图片，则图片的URL为：....</span></span><br><span class="line">                FILE_URL = <span class="string">&quot;https://&quot;</span> + bucketName + <span class="string">&quot;.&quot;</span> + endpoint + <span class="string">&quot;/&quot;</span> + fileUrl;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                FILE_URL = <span class="string">&quot;非图片，不可预览。文件路径为：&quot;</span> + fileUrl;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 上传文件</span></span><br><span class="line">            PutObjectResult result = ossClient.putObject(<span class="keyword">new</span> PutObjectRequest(bucketName, fileUrl, file));</span><br><span class="line">            <span class="comment">// 设置权限(公开读)</span></span><br><span class="line">            ossClient.setBucketAcl(bucketName, CannedAccessControlList.PublicRead);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;------OSS文件上传成功------&quot;</span> + fileUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OSSException oe) &#123;</span><br><span class="line">            logger.error(oe.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException ce) &#123;</span><br><span class="line">            logger.error(ce.getErrorMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ossClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ossClient.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> FILE_URL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过文件名下载文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName    要下载的文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> localFileName 本地要创建的文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">downloadFile</span><span class="params">(String objectName, String localFileName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        OSSClient ossClient = <span class="keyword">new</span> OSSClient(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line">        <span class="comment">// 下载OSS文件到本地文件。如果指定的本地文件存在会覆盖，不存在则新建。</span></span><br><span class="line">        ossClient.getObject(<span class="keyword">new</span> GetObjectRequest(bucketName, objectName), <span class="keyword">new</span> File(localFileName));</span><br><span class="line">        <span class="comment">// 关闭OSSClient。</span></span><br><span class="line">        ossClient.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列举 test 文件下所有的文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        OSSClient ossClient = <span class="keyword">new</span> OSSClient(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line">        <span class="comment">// 构造ListObjectsRequest请求。</span></span><br><span class="line">        ListObjectsRequest listObjectsRequest = <span class="keyword">new</span> ListObjectsRequest(bucketName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置prefix参数来获取fun目录下的所有文件。</span></span><br><span class="line">        listObjectsRequest.setPrefix(<span class="string">&quot;test/&quot;</span>);</span><br><span class="line">        <span class="comment">// 列出文件。</span></span><br><span class="line">        ObjectListing listing = ossClient.listObjects(listObjectsRequest);</span><br><span class="line">        <span class="comment">// 遍历所有文件。</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Objects:&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (OSSObjectSummary objectSummary : listing.getObjectSummaries()) &#123;</span><br><span class="line">            System.out.println(objectSummary.getKey());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历所有commonPrefix。</span></span><br><span class="line">        System.out.println(<span class="string">&quot;CommonPrefixes:&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String commonPrefix : listing.getCommonPrefixes()) &#123;</span><br><span class="line">            System.out.println(commonPrefix);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关闭OSSClient。</span></span><br><span class="line">        ossClient.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="四-Controller-层编写相关测试方法"><a href="#四-Controller-层编写相关测试方法" class="headerlink" title="四 Controller 层编写相关测试方法"></a>四 Controller 层编写相关测试方法</h2><p>上传文件 <code>upLoad(File file) </code>、通过文件名下载文件<code>downloadFile(String objectName, String localFileName) </code>、列出某个文件夹下的所有文件<code>listFile( )</code> 这三个方法都在下面有对应的简单测试。另外，还有一个方法<code> uploadPicture(@RequestParam(&quot;file&quot;) MultipartFile file, Model model)</code>对应于我们等下要实现的图床功能,该方法从前端接受到图片之后上传到阿里云OSS存储空间并返回上传成功的图片 URL 地址给前端。</p>
<p><strong>注意将下面的相关路径改成自己的，不然会报错！！！</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: SnailClimb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2018/12/2 16:56</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 阿里云OSS服务Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/oss&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliyunOSSController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> org.slf4j.Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AliyunOSSUtil aliyunOSSUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试上传文件到阿里云OSS存储</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testUpload&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testUpload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">&quot;E:/Picture/test.jpg&quot;</span>);</span><br><span class="line">        AliyunOSSUtil aliyunOSSUtil = <span class="keyword">new</span> AliyunOSSUtil();</span><br><span class="line">        String url = aliyunOSSUtil.upLoad(file);</span><br><span class="line">        System.out.println(url);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过文件名下载文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testDownload&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testDownload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AliyunOSSUtil aliyunOSSUtil = <span class="keyword">new</span> AliyunOSSUtil();</span><br><span class="line">        aliyunOSSUtil.downloadFile(</span><br><span class="line">                <span class="string">&quot;test/2018-12-04/e3f892c27f07462a864a43b8187d4562-rawpixel-600782-unsplash.jpg&quot;</span>,<span class="string">&quot;E:/Picture/e3f892c27f07462a864a43b8187d4562-rawpixel-600782-unsplash.jpg&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出某个文件夹下的所有文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testListFile&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testListFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AliyunOSSUtil aliyunOSSUtil = <span class="keyword">new</span> AliyunOSSUtil();</span><br><span class="line">        aliyunOSSUtil.listFile();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传（供前端调用）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/uploadFile&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">uploadPicture</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file, Model model)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;文件上传&quot;</span>);</span><br><span class="line">        String filename = file.getOriginalFilename();</span><br><span class="line">        System.out.println(filename);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(filename.trim())) &#123;</span><br><span class="line">                    File newFile = <span class="keyword">new</span> File(filename);</span><br><span class="line">                    FileOutputStream os = <span class="keyword">new</span> FileOutputStream(newFile);</span><br><span class="line">                    os.write(file.getBytes());</span><br><span class="line">                    os.close();</span><br><span class="line">                    file.transferTo(newFile);</span><br><span class="line">                    <span class="comment">// 上传到OSS</span></span><br><span class="line">                    String uploadUrl = aliyunOSSUtil.upLoad(newFile);</span><br><span class="line">                    model.addAttribute(<span class="string">&quot;url&quot;</span>,uploadUrl);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五-启动类"><a href="#五-启动类" class="headerlink" title="五 启动类"></a>五 启动类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootOssApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringbootOssApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="六-上传图片相关前端页面"><a href="#六-上传图片相关前端页面" class="headerlink" title="六 上传图片相关前端页面"></a>六 上传图片相关前端页面</h2><p>注意引入jquery ，避免前端出错。</p>
<p><strong>index.html</strong></p>
<p>JS 的内容主要是让我们上传的图片可以预览，就像我们在网站更换头像的时候一样。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span> xmlns:th=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;基于阿里云OSS存储的图床&lt;/title&gt;</span><br><span class="line">    &lt;script th:src=<span class="string">&quot;@&#123;/js/jquery-3.3.1.js&#125;&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        * &#123;</span><br><span class="line">            margin: <span class="number">0</span>;</span><br><span class="line">            padding: <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #submit &#123;</span><br><span class="line">            margin-left: 15px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        .preview_box img &#123;</span><br><span class="line">            width: 200px;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;/oss/uploadFile&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;form-group&quot;</span> id=<span class="string">&quot;group&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;img_input&quot;</span> name=<span class="string">&quot;file&quot;</span> accept=<span class="string">&quot;image/*&quot;</span>&gt;</span><br><span class="line">        &lt;label <span class="keyword">for</span>=<span class="string">&quot;img_input&quot;</span> &gt;&lt;/label&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;button type=<span class="string">&quot;submit&quot;</span> id=<span class="string">&quot;submit&quot;</span>&gt;上传&lt;/button&gt;</span><br><span class="line">    &lt;!--预览图片--&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;preview_box&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    $(<span class="string">&quot;#img_input&quot;</span>).on(<span class="string">&quot;change&quot;</span>, function (e) &#123;</span><br><span class="line">        <span class="keyword">var</span> file = e.target.files[<span class="number">0</span>]; <span class="comment">//获取图片资源</span></span><br><span class="line">        <span class="comment">// 只选择图片文件</span></span><br><span class="line">        <span class="keyword">if</span> (!file.type.match(<span class="string">&#x27;image.*&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">        reader.readAsDataURL(file); <span class="comment">// 读取文件</span></span><br><span class="line">        <span class="comment">// 渲染文件</span></span><br><span class="line">        reader.onload = function (arg) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> img = <span class="string">&#x27;&lt;img class=&quot;preview&quot; src=&quot;&#x27;</span> + arg.target.result + <span class="string">&#x27;&quot; alt=&quot;preview&quot;/&gt;&#x27;</span>;</span><br><span class="line">            $(<span class="string">&quot;.preview_box&quot;</span>).empty().append(img);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>success.html</strong></p>
<p>通过 <code>&lt;span th:text=&quot;$&#123;url&#125;&quot;&gt;&lt;/span&gt;</code> 引用后端传过来的值。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>上传结果<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>上传成功！<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">图片地址为：<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="七-测试我们的图床"><a href="#七-测试我们的图床" class="headerlink" title="七 测试我们的图床"></a>七 测试我们的图床</h2><p>访问 ：<a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a></p>
<p>① 上传图片</p>
<p><img src="http://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-12-4/6278013.jpg"></p>
<p>② 图片上传成功返回图片地址</p>
<p><img src="http://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-12-4/72081846.jpg"></p>
<p>③ 通过图片 URL 访问图片</p>
<p><img src="http://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-12-4/27895245.jpg" alt="通过图片 URL 访问图片"></p>
<p>我们终于能够独立利用阿里云 OSS 完成一个自己的图床服务，但是其实如果你想用阿里云OSS当做图床可以直接使用极简图床：<a target="_blank" rel="noopener" href="http://jiantuku.com/">http://jiantuku.com</a>  上传图片，比较方便！大家可能心里在想那你特么让我实现个图床干嘛？我觉得通过学习，大家以后可以做很多事情，比如 利用阿里云OSS 存储服务存放自己网站的相关图片。</p>
<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/source-code/advanced/springboot-oss">https://github.com/Snailclimb/springboot-guide/tree/master/source-code/advanced/springboot-oss</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-async/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-async/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文已经收录自 springboot-guide : <a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide">https://github.com/Snailclimb/springboot-guide</a> (Spring Boot 核心知识点整理。 基于 Spring Boot 2.19+。)</p>
</blockquote>
<h1 id="新手也能看懂的-SpringBoot-异步编程指南"><a href="#新手也能看懂的-SpringBoot-异步编程指南" class="headerlink" title="新手也能看懂的 SpringBoot 异步编程指南"></a>新手也能看懂的 SpringBoot 异步编程指南</h1><p>通过本文你可以了解到下面这些知识点：</p>
<ol>
<li>Future 模式介绍以及核心思想</li>
<li>核心线程数、最大线程数的区别，队列容量代表什么；</li>
<li><code>ThreadPoolTaskExecutor</code> 饱和策略；</li>
<li>SpringBoot 异步编程实战，搞懂代码的执行逻辑。</li>
</ol>
<h2 id="Future-模式"><a href="#Future-模式" class="headerlink" title="Future 模式"></a>Future 模式</h2><p>异步编程在处理耗时操作以及多任务处理的场景下非常有用，我们可以更好的让我们的系统利用好机器的 CPU 和 内存，提高它们的利用率。多线程设计模式有很多种，Future模式是多线程开发中非常常见的一种设计模式，本文也是基于这种模式来说明 SpringBoot 对于异步编程的知识。</p>
<p>实战之前我先简单介绍一下 <strong>Future 模式的核心思想</strong> 吧！。</p>
<p>Future 模式的核心思想是 <strong>异步调用</strong> 。当我们执行一个方法时，假如这个方法中有多个耗时的任务需要同时去做，而且又不着急等待这个结果时可以让客户端立即返回然后，后台慢慢去计算任务。当然你也可以选择等这些任务都执行完了，再返回给客户端。这个在 Java 中都有很好的支持，我在后面的示例程序中会详细对比这两种方式的区别。</p>
<h2 id="SpringBoot-异步编程实战"><a href="#SpringBoot-异步编程实战" class="headerlink" title="SpringBoot 异步编程实战"></a>SpringBoot 异步编程实战</h2><p>如果我们需要在 SpringBoot 实现异步编程的话，通过 Spring 提供的两个注解会让这件事情变的非常简单。</p>
<ol>
<li><code>@EnableAsync</code>：通过在配置类或者Main类上加@EnableAsync开启对异步方法的支持。</li>
<li><code>@Async</code> 可以作用在类上或者方法上，作用在类上代表这个类的所有方法都是异步方法。</li>
</ol>
<h3 id="1-自定义-TaskExecutor"><a href="#1-自定义-TaskExecutor" class="headerlink" title="1. 自定义 TaskExecutor"></a>1. 自定义 TaskExecutor</h3><p>很多人对于 TaskExecutor 不是太了解，所以我们花一点篇幅先介绍一下这个东西。从名字就能看出它是任务的执行者，它领导执行着线程来处理任务，就像司令官一样，而我们的线程就好比一只只军队一样，这些军队可以异步对敌人进行打击👊。</p>
<p>Spring 提供了<code>TaskExecutor</code>接口作为任务执行者的抽象,它和<code>java.util.concurrent</code>包下的<code>Executor</code>接口很像。稍微不同的 <code>TaskExecutor</code>接口用到了 Java 8 的语法<code>@FunctionalInterface</code>声明这个接口是一个函数式接口。</p>
<p><code>org.springframework.core.task.TaskExecutor</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskExecutor</span> <span class="keyword">extends</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/TaskExecutor.png"></p>
<p>如果没有自定义Executor, Spring 将创建一个 <code>SimpleAsyncTaskExecutor</code> 并使用它。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.AsyncConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@author</span> shuang.kou */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncConfig</span> <span class="keyword">implements</span> <span class="title">AsyncConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_POOL_SIZE = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> QUEUE_CAPACITY = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Executor <span class="title">taskExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Spring 默认配置是核心线程数大小为1，最大线程容量大小不受限制，队列容量也不受限制。</span></span><br><span class="line">    ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">    <span class="comment">// 核心线程数</span></span><br><span class="line">    executor.setCorePoolSize(CORE_POOL_SIZE);</span><br><span class="line">    <span class="comment">// 最大线程数</span></span><br><span class="line">    executor.setMaxPoolSize(MAX_POOL_SIZE);</span><br><span class="line">    <span class="comment">// 队列大小</span></span><br><span class="line">    executor.setQueueCapacity(QUEUE_CAPACITY);</span><br><span class="line">    <span class="comment">// 当最大池已满时，此策略保证不会丢失任务请求，但是可能会影响应用程序整体性能。</span></span><br><span class="line">    executor.setRejectedExecutionHandler(<span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">    executor.setThreadNamePrefix(<span class="string">&quot;My ThreadPoolTaskExecutor-&quot;</span>);</span><br><span class="line">    executor.initialize();</span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><code>ThreadPoolTaskExecutor</code> 常见概念：</strong></p>
<ul>
<li><strong>Core Pool Size :</strong> 核心线程数线程数定义了最小可以同时运行的线程数量。</li>
<li><strong>Queue Capacity :</strong> 当新任务来的时候会先判断当前运行的线程数量是否达到核心线程数，如果达到的话，信任就会被存放在队列中。</li>
<li><strong>Maximum Pool Size :</strong> 当队列中存放的任务达到队列容量的时候，当前可以同时运行的线程数量变为最大线程数。</li>
</ul>
<p>一般情况下不会将队列大小设为：<code>Integer.MAX_VALUE</code>,也不会将核心线程数和最大线程数设为同样的大小，这样的话最大线程数的设置都没什么意义了，你也无法确定当前 CPU 和内存利用率具体情况如何。</p>
<p><strong>如果队列已满并且当前同时运行的线程数达到最大线程数的时候，如果再有新任务过来会发生什么呢？</strong></p>
<p> Spring 默认使用的是 <code>ThreadPoolExecutor.AbortPolicy</code>。在Spring的默认情况下，<code>ThreadPoolExecutor</code>  将抛出 <code>RejectedExecutionException</code> 来拒绝新来的任务 ，这代表你将丢失对这个任务的处理。 对于可伸缩的应用程序，建议使用 <code>ThreadPoolExecutor.CallerRunsPolicy</code>。当最大池被填满时，此策略为我们提供可伸缩队列。</p>
<p><strong><code>ThreadPoolTaskExecutor</code> 饱和策略定义:</strong></p>
<p>如果当前同时运行的线程数量达到最大线程数量时，<code>ThreadPoolTaskExecutor</code> 定义一些策略:</p>
<ul>
<li><strong>ThreadPoolExecutor.AbortPolicy</strong>：抛出 <code>RejectedExecutionException</code>来拒绝新任务的处理。</li>
<li><strong>ThreadPoolExecutor.CallerRunsPolicy</strong>：调用执行自己的线程运行任务。您不会任务请求。但是这种策略会降低对于新任务提交速度，影响程序的整体性能。另外，这个策略喜欢增加队列容量。如果您的应用程序可以承受此延迟并且你不能任务丢弃任何一个任务请求的话，你可以选择这个策略。</li>
<li><strong>ThreadPoolExecutor.DiscardPolicy：</strong> 不处理新任务，直接丢弃掉。</li>
<li><strong>ThreadPoolExecutor.DiscardOldestPolicy：</strong> 此策略将丢弃最早的未处理的任务请求。</li>
</ul>
<h3 id="2-编写一个异步的方法"><a href="#2-编写一个异步的方法" class="headerlink" title="2. 编写一个异步的方法"></a>2. 编写一个异步的方法</h3><p>下面模拟一个查找对应字符开头电影的方法，我们给这个方法加上了<code> @Async</code>注解来告诉 Spring 它是一个异步的方法。另外，这个方法的返回值 <code>CompletableFuture.completedFuture(results)</code>这代表我们需要返回结果，也就是说程序必须把任务执行完成之后再返回给用户。</p>
<p><strong>请留意<code>completableFutureTask</code>方法中的第一行打印日志这句代码，后面分析程序中会用到，很重要！</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletableFuture;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@author</span> shuang.kou */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AsyncService.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> List&lt;String&gt; movies =</span><br><span class="line">      <span class="keyword">new</span> ArrayList&lt;&gt;(</span><br><span class="line">          Arrays.asList(</span><br><span class="line">              <span class="string">&quot;Forrest Gump&quot;</span>,</span><br><span class="line">              <span class="string">&quot;Titanic&quot;</span>,</span><br><span class="line">              <span class="string">&quot;Spirited Away&quot;</span>,</span><br><span class="line">              <span class="string">&quot;The Shawshank Redemption&quot;</span>,</span><br><span class="line">              <span class="string">&quot;Zootopia&quot;</span>,</span><br><span class="line">              <span class="string">&quot;Farewell &quot;</span>,</span><br><span class="line">              <span class="string">&quot;Joker&quot;</span>,</span><br><span class="line">              <span class="string">&quot;Crawl&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 示范使用：找到特定字符/字符串开头的电影 */</span></span><br><span class="line">  <span class="meta">@Async</span></span><br><span class="line">  <span class="keyword">public</span> CompletableFuture&lt;List&lt;String&gt;&gt; completableFutureTask(String start) &#123;</span><br><span class="line">    <span class="comment">// 打印日志</span></span><br><span class="line">    logger.warn(Thread.currentThread().getName() + <span class="string">&quot;start this task!&quot;</span>);</span><br><span class="line">    <span class="comment">// 找到特定字符/字符串开头的电影</span></span><br><span class="line">    List&lt;String&gt; results =</span><br><span class="line">        movies.stream().filter(movie -&gt; movie.startsWith(start)).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 模拟这是一个耗时的任务</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回一个已经用给定值完成的新的CompletableFuture。</span></span><br><span class="line">    <span class="keyword">return</span> CompletableFuture.completedFuture(results);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-测试编写的异步方法"><a href="#3-测试编写的异步方法" class="headerlink" title="3. 测试编写的异步方法"></a>3. 测试编写的异步方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@author</span> shuang.kou */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/async&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span> </span><br><span class="line">  AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/movies&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">completableFutureTask</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">//开始时间</span></span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 开始执行大量的异步任务</span></span><br><span class="line">    List&lt;String&gt; words = Arrays.asList(<span class="string">&quot;F&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">    List&lt;CompletableFuture&lt;List&lt;String&gt;&gt;&gt; completableFutureList =</span><br><span class="line">        words.stream()</span><br><span class="line">            .map(word -&gt; asyncService.completableFutureTask(word))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// CompletableFuture.join（）方法可以获取他们的结果并将结果连接起来</span></span><br><span class="line">    List&lt;List&lt;String&gt;&gt; results = completableFutureList.stream().map(CompletableFuture::join).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 打印结果以及运行程序运行花费时间</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Elapsed time: &quot;</span> + (System.currentTimeMillis() - start));</span><br><span class="line">    <span class="keyword">return</span> results.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求这个接口，控制台打印出下面的内容：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">50</span>:<span class="number">17.007</span>  WARN <span class="number">18793</span> --- <span class="selector-attr">[lTaskExecutor-1]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">1s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">50</span>:<span class="number">17.007</span>  WARN <span class="number">18793</span> --- <span class="selector-attr">[lTaskExecutor-6]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">6s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">50</span>:<span class="number">17.007</span>  WARN <span class="number">18793</span> --- <span class="selector-attr">[lTaskExecutor-5]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">5s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">50</span>:<span class="number">17.007</span>  WARN <span class="number">18793</span> --- <span class="selector-attr">[lTaskExecutor-4]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">4s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">50</span>:<span class="number">17.007</span>  WARN <span class="number">18793</span> --- <span class="selector-attr">[lTaskExecutor-3]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">3s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">50</span>:<span class="number">17.007</span>  WARN <span class="number">18793</span> --- <span class="selector-attr">[lTaskExecutor-2]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">2s</span>tart this task!</span><br><span class="line">Elapsed <span class="selector-tag">time</span>: <span class="number">1010</span></span><br></pre></td></tr></table></figure>

<p>首先我们可以看到处理所有任务花费的时间大概是 1 s。这与我们自定义的 <code>ThreadPoolTaskExecutor</code> 有关，我们配置的核心线程数是 6 ，然后通过通过下面的代码模拟分配了 6 个任务给系统执行。这样每个线程都会被分配到一个任务，每个任务执行花费时间是 1 s ，所以处理 6 个任务的总花费时间是 1 s。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; words = Arrays.asList(<span class="string">&quot;F&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;C&quot;</span>);  </span><br><span class="line">List&lt;CompletableFuture&lt;List&lt;String&gt;&gt;&gt; completableFutureList =</span><br><span class="line">        words.stream()</span><br><span class="line">            .map(word -&gt; asyncService.completableFutureTask(word))</span><br><span class="line">            .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>你可以自己验证一下，试着去把核心线程数的数量改为 3 ，再次请求这个接口你会发现处理所有任务花费的时间大概是 2 s。</p>
<p>另外，<strong>从上面的运行结果可以看出，当所有任务执行完成之后才返回结果。这种情况对应于我们需要返回结果给客户端请求的情况下，假如我们不需要返回任务执行结果给客户端的话呢？</strong> 就比如我们上传一个大文件到系统，上传之后只要大文件格式符合要求我们就上传成功。普通情况下我们需要等待文件上传完毕再返回给用户消息，但是这样会很慢。采用异步的话，当用户上传之后就立马返回给用户消息，然后系统再默默去处理上传任务。<strong>这样也会增加一点麻烦，因为文件可能会上传失败，所以系统也需要一点机制来补偿这个问题，比如当上传遇到问题的时候，发消息通知用户。</strong></p>
<p>下面会演示一下客户端不需要返回结果的情况：</p>
<p>将<code>completableFutureTask</code>方法变为 void 类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completableFutureTask</span><span class="params">(String start)</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="comment">//这里可能是系统对任务执行结果的处理，比如存入到数据库等等......</span></span><br><span class="line">  <span class="comment">//doSomeThingWithResults(results);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller 代码修改如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/movies&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">completableFutureTask</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// Start the clock</span></span><br><span class="line">  <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">  <span class="comment">// Kick of multiple, asynchronous lookups</span></span><br><span class="line">  List&lt;String&gt; words = Arrays.asList(<span class="string">&quot;F&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">      words.stream()</span><br><span class="line">          .forEach(word -&gt; asyncService.completableFutureTask(word));</span><br><span class="line">  <span class="comment">// Wait until they are all done</span></span><br><span class="line">  <span class="comment">// Print results, including elapsed time</span></span><br><span class="line">  System.out.println(<span class="string">&quot;Elapsed time: &quot;</span> + (System.currentTimeMillis() - start));</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Done&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求这个接口，控制台打印出下面的内容：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Elapsed <span class="selector-tag">time</span>: <span class="number">0</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">44.052</span>  WARN <span class="number">19051</span> --- <span class="selector-attr">[lTaskExecutor-4]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">4s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">44.052</span>  WARN <span class="number">19051</span> --- <span class="selector-attr">[lTaskExecutor-3]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">3s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">44.052</span>  WARN <span class="number">19051</span> --- <span class="selector-attr">[lTaskExecutor-2]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">2s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">44.052</span>  WARN <span class="number">19051</span> --- <span class="selector-attr">[lTaskExecutor-1]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">1s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">44.052</span>  WARN <span class="number">19051</span> --- <span class="selector-attr">[lTaskExecutor-6]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">6s</span>tart this task!</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">01</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">44.052</span>  WARN <span class="number">19051</span> --- <span class="selector-attr">[lTaskExecutor-5]</span> g<span class="selector-class">.j</span><span class="selector-class">.a</span><span class="selector-class">.service</span><span class="selector-class">.AsyncService</span>               : My ThreadPoolTaskExecutor-<span class="number">5s</span>tart this task!</span><br></pre></td></tr></table></figure>

<p>可以看到系统会直接返回给用户结果，然后系统才真正开始执行任务。</p>
<h2 id="待办"><a href="#待办" class="headerlink" title="待办"></a>待办</h2><ul>
<li><input disabled="" type="checkbox"> <a target="_blank" rel="noopener" href="https://blog.knoldus.com/future-vs-completablefuture-1/"><strong>Future vs. CompletableFuture</strong></a></li>
<li><input disabled="" type="checkbox"> 源代码分析</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/async-method/">https://spring.io/guides/gs/async-method/</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/trendyol-tech/spring-boot-async-executor-management-with-threadpooltaskexecutor-f493903617d">https://medium.com/trendyol-tech/spring-boot-async-executor-management-with-threadpooltaskexecutor-f493903617d</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-handle-exception-plus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/springboot-handle-exception-plus/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>这篇文章鸽了很久，我在这篇文章 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247486111&idx=2&sn=8299a42edc4733bdf012ebfe9ebf3fbb&chksm=cea24554f9d5cc42eac0e0ecd851c201831f3b149e64fe11f94b548031f10ff2dac1ea9743d3&token=1729829670&lang=zh_CN#rd">《用好Java中的枚举，真的没有那么简单！》</a> 中就提到要分享。还是昨天一个读者提醒我之后，我才发现自己没有将这篇文章发到公众号。说到这里，我发现自己一个很大的问题，就是有时候在文章里面说要更新什么，结果后面就忘记了，很多时候不是自己没写，就因为各种事情混杂导致忘记发了。以后要尽量改正这个问题！</p>
</blockquote>
<p>在上一篇文章<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485568&idx=2&sn=c5ba880fd0c5d82e39531fa42cb036ac&chksm=cea2474bf9d5ce5dcbc6a5f6580198fdce4bc92ef577579183a729cb5d1430e4994720d59b34&token=1729829670&lang=zh_CN#rd">《SpringBoot 处理异常的几种常见姿势》</a>中我介绍了：</p>
<ol>
<li>使用 <code>@ControllerAdvice</code> 和 <code>@ExceptionHandler</code> 处理全局异常</li>
<li><code>@ExceptionHandler</code> 处理 Controller 级别的异常</li>
<li><code>ResponseStatusException</code> </li>
</ol>
<p>通过这篇文章，可以搞懂如何在 Spring Boot 中进行异常处理。但是，光是会用了还不行，我们还要思考如何把异常处理这部分的代码写的稍微优雅一点。下面我会以我在工作中学到的一点实际项目中异常处理的方式，来说说我觉得稍微优雅点的异常处理解决方案。</p>
<p>下面仅仅是我作为一个我个人的角度来看的，如果各位读者有更好的解决方案或者觉得本文提出的方案还有优化的余地的话，欢迎在评论区评论。</p>
<h2 id="最终效果展示"><a href="#最终效果展示" class="headerlink" title="最终效果展示"></a>最终效果展示</h2><p>下面先来展示一下完成后的效果，当我们定义的异常被系统捕捉后返回给客户端的信息是这样的：</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86plus-%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA.jpg" alt="效果展示"></p>
<p>返回的信息包含了异常下面 5 部分内容：</p>
<ol>
<li>唯一标示异常的 code</li>
<li>HTTP状态码</li>
<li>错误路径</li>
<li>发生错误的时间戳</li>
<li>错误的具体信息</li>
</ol>
<p>这样返回异常信息，更利于我们前端根据异常信息做出相应的表现。</p>
<h2 id="异常处理核心代码"><a href="#异常处理核心代码" class="headerlink" title="异常处理核心代码"></a>异常处理核心代码</h2><p><code>ErrorCode.java</code> (此枚举类中包含了异常的唯一标识、HTTP状态码以及错误信息)</p>
<p>这个类的主要作用就是统一管理系统中可能出现的异常，比较清晰明了。但是，可能出现的问题是当系统过于复杂，出现的异常过多之后，这个类会比较庞大。有一种解决办法：将多种相似的异常统一为一个，比如将用户找不到异常和订单信息未找到的异常都统一为“未找到该资源”这一种异常，然后前端再对相应的情况做详细处理（我个人的一种处理方法，不敢保证是比较好的一种做法）。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ErrorCode</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    RESOURCE_NOT_FOUND(<span class="number">1001</span>, HttpStatus.NOT_FOUND, <span class="string">&quot;未找到该资源&quot;</span>),</span><br><span class="line">    REQUEST_VALIDATION_FAILED(<span class="number">1002</span>, HttpStatus.BAD_REQUEST, <span class="string">&quot;请求数据格式验证失败&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpStatus status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    ErrorCode(<span class="keyword">int</span> code, HttpStatus status, String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpStatus <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ErrorCode&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;code=&quot;</span> + code +</span><br><span class="line">                <span class="string">&quot;, status=&quot;</span> + status +</span><br><span class="line">                <span class="string">&quot;, message=&#x27;&quot;</span> + message + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>ErrorReponse.java</code>（返回给客户端具体的异常对象）</strong></p>
<p>这个类作为异常信息返回给客户端，里面包括了当出现异常时我们想要返回给客户端的所有信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorReponse</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="keyword">private</span> Instant timestamp;</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorReponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorReponse</span><span class="params">(BaseException ex, String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(ex.getError().getCode(), ex.getError().getStatus().value(), ex.getError().getMessage(), path, ex.getData());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorReponse</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> status, String message, String path, Map&lt;String, Object&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = Instant.now();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(data)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.data.putAll(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略 getter/setter 方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ErrorReponse&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;code=&quot;</span> + code +</span><br><span class="line">                <span class="string">&quot;, status=&quot;</span> + status +</span><br><span class="line">                <span class="string">&quot;, message=&#x27;&quot;</span> + message + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, path=&#x27;&quot;</span> + path + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, timestamp=&quot;</span> + timestamp +</span><br><span class="line">                <span class="string">&quot;, data=&quot;</span> + data +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><code>BaseException.java</code>（继承自 <code>RuntimeException</code> 的抽象类，可以看做系统中其他异常类的父类）</strong></p>
<p>系统中的异常类都要继承自这个类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ErrorCode error;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseException</span><span class="params">(ErrorCode error, Map&lt;String, Object&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(error.getMessage());</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(data)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.data.putAll(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">BaseException</span><span class="params">(ErrorCode error, Map&lt;String, Object&gt; data, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(error.getMessage(), cause);</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(data)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.data.putAll(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ErrorCode <span class="title">getError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>ResourceNotFoundException.java</code> （自定义异常）</strong></p>
<p>可以看出通过继承 <code>BaseException</code> 类我们自定义异常会变的非常简单！</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceNotFoundException</span> <span class="keyword">extends</span> <span class="title">BaseException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResourceNotFoundException</span><span class="params">(Map&lt;String, Object&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ErrorCode.RESOURCE_NOT_FOUND, data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>GlobalExceptionHandler.java</code>（全局异常捕获）</strong></p>
<p>我们定义了两个异常捕获方法。</p>
<p>这里再说明一下，实际上这个类只需要 <code>handleAppException()</code> 这一个方法就够了，因为它是本系统所有异常的父类。只要是抛出了继承 <code>BaseException</code> 类的异常后都会在这里被处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.twuc.webApp.web.ExceptionController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice(assignableTypes = &#123;ExceptionController.class&#125;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 也可以将 BaseException 换为 RuntimeException </span></span><br><span class="line">    <span class="comment">// 因为 RuntimeException 是 BaseException 的父类</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(BaseException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; handleAppException(BaseException ex, HttpServletRequest request) &#123;</span><br><span class="line">        ErrorReponse representation = <span class="keyword">new</span> ErrorReponse(ex, request.getRequestURI());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(representation, <span class="keyword">new</span> HttpHeaders(), ex.getError().getStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = ResourceNotFoundException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;ErrorReponse&gt; <span class="title">handleResourceNotFoundException</span><span class="params">(ResourceNotFoundException ex, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        ErrorReponse errorReponse = <span class="keyword">new</span> ErrorReponse(ex, request.getRequestURI());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorReponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>（重要）一点扩展：</strong></p>
<p>哈哈！实际上我多加了一个算是多余的异常捕获方法<code>handleResourceNotFoundException()</code> 主要是为了考考大家当我们抛出了 <code>ResourceNotFoundException</code>异常会被下面哪一个方法捕获呢？</p>
<p>答案：</p>
<p>会被<code>handleResourceNotFoundException()</code>方法捕获。因为 <code>@ExceptionHandler</code> 捕获异常的过程中，会优先找到最匹配的。</p>
<p>下面通过源码简单分析一下：</p>
<p><code>ExceptionHandlerMethodResolver.java</code>中<code>getMappedMethod</code>决定了具体被哪个方法处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Method <span class="title">getMappedMethod</span><span class="params">(Class&lt;? extends Throwable&gt; exceptionType)</span> </span>&#123;</span><br><span class="line">		List&lt;Class&lt;? extends Throwable&gt;&gt; matches = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//找到可以处理的所有异常信息。mappedMethods 中存放了异常和处理异常的方法的对应关系</span></span><br><span class="line">		<span class="keyword">for</span> (Class&lt;? extends Throwable&gt; mappedException : <span class="keyword">this</span>.mappedMethods.keySet()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (mappedException.isAssignableFrom(exceptionType)) &#123;</span><br><span class="line">				matches.add(mappedException);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// 不为空说明有方法处理异常</span></span><br><span class="line">		<span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// 按照匹配程度从小到大排序</span></span><br><span class="line">			matches.sort(<span class="keyword">new</span> ExceptionDepthComparator(exceptionType));</span><br><span class="line">      <span class="comment">// 返回处理异常的方法</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.mappedMethods.get(matches.get(<span class="number">0</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>从源代码看出：**<code>getMappedMethod()</code>会首先找到可以匹配处理异常的所有方法信息，然后对其进行从小到大的排序，最后取最小的那一个匹配的方法(即匹配度最高的那个)。**</p>
<h2 id="写一个抛出异常的类测试"><a href="#写一个抛出异常的类测试" class="headerlink" title="写一个抛出异常的类测试"></a>写一个抛出异常的类测试</h2><p><strong><code>Person.java</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略 getter/setter 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>ExceptionController.java</code>（抛出异常的类）</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resourceNotFound&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Person p=<span class="keyword">new</span> Person(<span class="number">1L</span>,<span class="string">&quot;SnailClimb&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ResourceNotFoundException(ImmutableMap.of(<span class="string">&quot;person id:&quot;</span>, p.getId()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/source-code/basis/springboot-handle-exception-improved">https://github.com/Snailclimb/springboot-guide/tree/master/source-code/basis/springboot-handle-exception-improved</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/README/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/README/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://www.aliyun.com/minisite/goods?userCode=hf47liqn">推荐一下：阿里云高性能服务器，1核1g最低89，不限性能。</a></p>
<p align="center">
<a href="https://github.com/Snailclimb/springboot-guide" target="_blank">
    <img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/spring-boot-guide.png" width=""/>
</a>
</p>

<p align="center">
  <a target="_blank" rel="noopener" href="https://snailclimb.gitee.io/springboot-guide "><img src="https://img.shields.io/badge/阅读-read-brightgreen.svg" alt="阅读"></a>
  <a href="#联系我"><img src="https://img.shields.io/badge/chat-微信群-blue.svg" alt="微信群"></a>
  <a href="#公众号"><img src="https://img.shields.io/badge/%E5%85%AC%E4%BC%97%E5%8F%B7-JavaGuide-lightgrey.svg" alt="公众号"></a>
  <a href="#公众号"><img src="https://img.shields.io/badge/PDF-Java面试突击-important.svg" alt="公众号"></a>
</p>

<p><strong>在线阅读：</strong> <a target="_blank" rel="noopener" href="https://snailclimb.gitee.io/springboot-guide">https://snailclimb.gitee.io/springboot-guide</a> （上面的地址访问速度缓慢的建议使用这个路径访问）</p>
<h2 id="重要知识点"><a href="#重要知识点" class="headerlink" title="重要知识点"></a>重要知识点</h2><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><ol>
<li><strong><a href="./docs/SpringBoot/guideBro/start/springboot-introduction.md">Spring Boot 介绍</a></strong></li>
<li><a href="./docs/SpringBoot/guideBro/start/springboot-system-requirements.md">SpringBoot 开发环境要求</a></li>
<li><strong><a href="./docs/SpringBoot/guideBro/start/springboot-hello-world.md">Spring Boot 版 Hello World &amp; Spring Boot 项目结构分析</a></strong></li>
</ol>
<h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><ol>
<li><strong><a href="./docs/SpringBoot/guideBro/basis/sringboot-restful-web-service.md">开发 RestFul Web 服务</a></strong></li>
<li><a href="./docs/SpringBoot/guideBro/basis/RestControllerVSController.md">RestController VS Controller</a></li>
<li><a href="./docs/SpringBoot/guideBro/basis/@PostConstruct%E4%B8%8E@PreDestroy.md"><code>@PostConstruct</code>和<code>@PreDestroy</code> 简单使用以及Java9+中的替代方案</a> </li>
<li><strong><a href="./docs/SpringBoot/guideBro/basis/read-config-properties.md">Spring 如何优雅读取配置文件？</a></strong> </li>
<li><strong><a href="./docs/SpringBoot/guideBro/advanced/springboot-handle-exception.md">Spring Boot 异常处理</a></strong></li>
<li><strong><a href="./docs/SpringBoot/guideBro/advanced/springboot-handle-exception-plus.md">实际项目中我们是这样做异常处理的</a></strong></li>
<li><a href="./docs/SpringBoot/guideBro/basis/spring-boot-devtools.md">使用 spring-boot-devtools 进行热部署</a> （实际项目不太推荐热部署，影响效率）</li>
<li><strong><a href="./docs/SpringBoot/guideBro/basis/springboot-jpa.md"> Spring Boot JPA 基础：常见操作解析</a></strong></li>
<li><strong><a href="./docs/SpringBoot/guideBro/basis/springboot-jpa-lianbiao.md">JPA 中非常重要的连表查询就是这么简单</a></strong></li>
<li><a href="./docs/SpringBoot/guideBro/basis/springboot-filter.md">SpringBoot 实现过滤器</a></li>
<li><a href="./docs/SpringBoot/guideBro/basis/springboot-interceptor.md">SpringBoot 实现拦截器</a></li>
<li><a href="./docs/SpringBoot/guideBro/basis/springboot-mybatis.md">整合 SpringBoot+Mybatis</a> 、<a href="./docs/SpringBoot/guideBro/basis/springboot-mybatis-mutipledatasource.md">SpirngBoot2.0+ 的 SpringBoot+Mybatis 多数据源配置</a></li>
</ol>
<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><ol>
<li><strong><a href="./docs/SpringBoot/guideBro/advanced/Apache-BeanUtils-VS-SpringBean-Utils.md">Bean映射工具之Apache BeanUtils VS Spring BeanUtils</a></strong></li>
<li><a href="./docs/SpringBoot/guideBro/advanced/Performance-of-Java-Mapping-Frameworks.md">5种常见Bean映射工具的性能比对</a></li>
<li><strong><a href="./docs/SpringBoot/guideBro/advanced/spring-bean-validation.md">如何在 Spring/Spring Boot 中做参数校验？你需要了解的都在这里！</a></strong></li>
<li><a href="./docs/SpringBoot/guideBro/advanced/SpringBoot-ScheduleTasks.md">5分钟搞懂如何在Spring Boot中Schedule Tasks</a> </li>
<li><strong><a href="./docs/SpringBoot/guideBro/advanced/springboot-async.md">新手也能看懂的 Spring Boot 异步编程指南</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-kafka">Kafka 入门+SpringBoot整合Kafka系列</a></strong></li>
<li><a href="./docs/SpringBoot/guideBro/advanced/springboot-dubbo.md">超详细，新手都能看懂 ！使用Spring Boot+Dubbo 搭建一个分布式服务</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/spring-security-jwt-guide">从零入门 ！Spring Security With JWT（含权限验证）</a></li>
</ol>
<h3 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h3><ul>
<li><a href="./docs/SpringBoot/guideBro/interview/springboot-questions.md">几道简单的 SpringBoot面试题</a></li>
</ul>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ol>
<li>项目 logo 由 <a target="_blank" rel="noopener" href="https://logoly.pro/#/">logoly</a> 生成。</li>
<li>利用 docsify 生成文档部署在 Github pages: <a target="_blank" rel="noopener" href="https://docsify.js.org/#/">docsify 官网介绍</a></li>
</ol>
<h3 id="联系我"><a href="#联系我" class="headerlink" title="联系我"></a>联系我</h3><p>添加我的微信备注“Github”,回复关键字 <strong>“加群”</strong> 即可入群。</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/wechat3.jpeg" alt="个人微信"></p>
<h3 id="公众号"><a href="#公众号" class="headerlink" title="公众号"></a>公众号</h3><p>如果大家想要实时关注我更新的文章以及分享的干货的话，可以关注我的公众号。</p>
<p><strong>《Java面试突击》:</strong> 由本文档衍生的专为面试而生的《Java面试突击》V2.0 PDF 版本<a href="#%E5%85%AC%E4%BC%97%E5%8F%B7">公众号</a>后台回复 <strong>“Java面试突击”</strong> 即可免费领取！</p>
<p><strong>Java工程师必备学习资源:</strong> 一些Java工程师常用学习资源公众号后台回复关键字 <strong>“1”</strong> 即可免费无套路获取。 </p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/167598cd2e17b8ec.png" alt="我的公众号"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/Apache-BeanUtils-VS-SpringBean-Utils/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/Apache-BeanUtils-VS-SpringBean-Utils/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文转载自：<a target="_blank" rel="noopener" href="https://pjmike.github.io/2018/11/03/Bean%E6%98%A0%E5%B0%84%E5%B7%A5%E5%85%B7%E4%B9%8BApache-BeanUtils-VS-Spring-BeanUtils/">https://pjmike.github.io/2018/11/03/Bean映射工具之Apache-BeanUtils-VS-Spring-BeanUtils/</a>,作者 pjmike 。</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在我们实际项目开发过程中，我们经常需要将不同的两个对象实例进行属性复制，从而基于源对象的属性信息进行后续操作，而不改变源对象的属性信息,比如DTO数据传输对象和数据对象DO，我们需要将DO对象进行属性复制到DTO，但是对象格式又不一样，所以我们需要编写映射代码将对象中的属性值从一种类型转换成另一种类型。</p>
<h2 id="对象拷贝"><a href="#对象拷贝" class="headerlink" title="对象拷贝"></a>对象拷贝</h2><p>在具体介绍两种 BeanUtils 之前，先来补充一些基础知识。它们两种工具本质上就是对象拷贝工具，而对象拷贝又分为深拷贝和浅拷贝，下面进行详细解释。</p>
<h3 id="什么是浅拷贝和深拷贝"><a href="#什么是浅拷贝和深拷贝" class="headerlink" title="什么是浅拷贝和深拷贝"></a>什么是浅拷贝和深拷贝</h3><p>在Java中，除了 <strong>基本数据类型</strong>之外，还存在 <strong>类的实例对象</strong>这个引用数据类型，而一般使用 “=”号做赋值操作的时候，对于基本数据类型，实际上是拷贝的它的值，但是对于对象而言，其实赋值的只是这个对象的引用，将原对象的引用传递过去，他们实际还是指向的同一个对象。</p>
<p>而浅拷贝和深拷贝就是在这个基础上做的区分，如果在拷贝这个对象的时候，只对基本数据类型进行了拷贝，而对引用数据类型只是进行引用的传递，而没有真实的创建一个新的对象，则认为是<strong>浅拷贝</strong>。反之，在对引用数据类型进行拷贝的时候，创建了一个新的对象，并且复制其内的成员变量，则认为是<strong>深拷贝</strong>。</p>
<p>简单来说:</p>
<ul>
<li><strong>浅拷贝</strong>：对基本数据类型进行值传递，对引用数据类型进行引用传递般的拷贝，此为浅拷贝</li>
<li><strong>深拷贝</strong>： 对基本数据类型进行值传递，对引用数据类型，创建一个新的对象，并复制其内容，此为深拷贝。</li>
</ul>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/java-deep-and-shallow-copy.jpg" alt="deep and shallow copy"></p>
<h2 id="BeanUtils"><a href="#BeanUtils" class="headerlink" title="BeanUtils"></a>BeanUtils</h2><p>前面简单讲了一下对象拷贝的一些知识，下面就来具体看下两种 BeanUtils 工具</p>
<h3 id="Apache-的-BeanUtils"><a href="#Apache-的-BeanUtils" class="headerlink" title="Apache 的 BeanUtils"></a>Apache 的 BeanUtils</h3><p>首先来看一个非常简单的BeanUtils的例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonSource</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">// getters/setters omiited</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonDest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">// getters/setters omiited</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApacheBeanUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">       <span class="comment">//下面只是用于单独测试</span></span><br><span class="line">        PersonSource personSource = <span class="keyword">new</span> PersonSource(<span class="number">1</span>, <span class="string">&quot;pjmike&quot;</span>, <span class="string">&quot;12345&quot;</span>, <span class="number">21</span>);</span><br><span class="line">        PersonDest personDest = <span class="keyword">new</span> PersonDest();</span><br><span class="line">        BeanUtils.copyProperties(personDest,personSource);</span><br><span class="line">        System.out.println(<span class="string">&quot;persondest: &quot;</span>+personDest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">persondest: PersonDest&#123;id=<span class="number">1</span>, username=<span class="string">&#x27;pjmike&#x27;</span>, age=<span class="number">21</span>&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的例子可以看出，对象拷贝非常简单，BeanUtils最常用的方法就是:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//将源对象中的值拷贝到目标对象</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyProperties</span><span class="params">(Object dest, Object orig)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line">    BeanUtilsBean.getInstance().copyProperties(dest, orig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下，使用<code>org.apache.commons.beanutils.BeanUtils</code>对复杂对象的复制是引用，这是一种<strong>浅拷贝</strong></p>
<p>但是由于 Apache下的BeanUtils对象拷贝性能太差，不建议使用，而且在<strong>阿里巴巴Java开发规约插件</strong>上也明确指出：</p>
<blockquote>
<p>Ali-Check | 避免用Apache Beanutils进行属性的copy。</p>
</blockquote>
<p>commons-beantutils 对于对象拷贝加了很多的检验，包括类型的转换，甚至还会检验对象所属的类的可访问性,可谓相当复杂，这也造就了它的差劲的性能，具体实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyProperties</span><span class="params">(<span class="keyword">final</span> Object dest, <span class="keyword">final</span> Object orig)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate existence of the specified beans</span></span><br><span class="line">        <span class="keyword">if</span> (dest == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException</span><br><span class="line">                    (<span class="string">&quot;No destination bean specified&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (orig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;No origin bean specified&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;BeanUtils.copyProperties(&quot;</span> + dest + <span class="string">&quot;, &quot;</span> +</span><br><span class="line">                      orig + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Copy the properties, converting as necessary</span></span><br><span class="line">        <span class="keyword">if</span> (orig <span class="keyword">instanceof</span> DynaBean) &#123;</span><br><span class="line">            <span class="keyword">final</span> DynaProperty[] origDescriptors =</span><br><span class="line">                ((DynaBean) orig).getDynaClass().getDynaProperties();</span><br><span class="line">            <span class="keyword">for</span> (DynaProperty origDescriptor : origDescriptors) &#123;</span><br><span class="line">                <span class="keyword">final</span> String name = origDescriptor.getName();</span><br><span class="line">                <span class="comment">// Need to check isReadable() for WrapDynaBean</span></span><br><span class="line">                <span class="comment">// (see Jira issue# BEANUTILS-61)</span></span><br><span class="line">                <span class="keyword">if</span> (getPropertyUtils().isReadable(orig, name) &amp;&amp;</span><br><span class="line">                    getPropertyUtils().isWriteable(dest, name)) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Object value = ((DynaBean) orig).get(name);</span><br><span class="line">                    copyProperty(dest, name, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (orig <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="keyword">final</span></span><br><span class="line">            <span class="comment">// Map properties are always of type &lt;String, Object&gt;</span></span><br><span class="line">            Map&lt;String, Object&gt; propMap = (Map&lt;String, Object&gt;) orig;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, Object&gt; entry : propMap.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">final</span> String name = entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (getPropertyUtils().isWriteable(dest, name)) &#123;</span><br><span class="line">                    copyProperty(dest, name, entry.getValue());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="comment">/* if (orig is a standard JavaBean) */</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> PropertyDescriptor[] origDescriptors =</span><br><span class="line">                getPropertyUtils().getPropertyDescriptors(orig);</span><br><span class="line">            <span class="keyword">for</span> (PropertyDescriptor origDescriptor : origDescriptors) &#123;</span><br><span class="line">                <span class="keyword">final</span> String name = origDescriptor.getName();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;class&quot;</span>.equals(name)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// No point in trying to set an object&#x27;s class</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (getPropertyUtils().isReadable(orig, name) &amp;&amp;</span><br><span class="line">                    getPropertyUtils().isWriteable(dest, name)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> Object value =</span><br><span class="line">                            getPropertyUtils().getSimpleProperty(orig, name);</span><br><span class="line">                        copyProperty(dest, name, value);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException e) &#123;</span><br><span class="line">                        <span class="comment">// Should not happen</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-的-BeanUtils"><a href="#Spring-的-BeanUtils" class="headerlink" title="Spring 的 BeanUtils"></a>Spring 的 BeanUtils</h3><p>使用spring的BeanUtils进行对象拷贝:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSpringBeanUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//下面只是用于单独测试</span></span><br><span class="line">        PersonSource personSource = <span class="keyword">new</span> PersonSource(<span class="number">1</span>, <span class="string">&quot;pjmike&quot;</span>, <span class="string">&quot;12345&quot;</span>, <span class="number">21</span>);</span><br><span class="line">        PersonDest personDest = <span class="keyword">new</span> PersonDest();</span><br><span class="line">        BeanUtils.copyProperties(personSource,personDest);</span><br><span class="line">        System.out.println(<span class="string">&quot;persondest: &quot;</span>+personDest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>spring下的BeanUtils也是使用 <code>copyProperties</code>方法进行拷贝，只不过它的实现方式非常简单，就是对两个对象中相同名字的属性进行简单的get/set，仅检查属性的可访问性。具体实现如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyProperties</span><span class="params">(Object source, Object target, <span class="meta">@Nullable</span> Class&lt;?&gt; editable,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@Nullable</span> String... ignoreProperties)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.notNull(source, <span class="string">&quot;Source must not be null&quot;</span>);</span><br><span class="line">		Assert.notNull(target, <span class="string">&quot;Target must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">		Class&lt;?&gt; actualEditable = target.getClass();</span><br><span class="line">		<span class="keyword">if</span> (editable != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!editable.isInstance(target)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Target class [&quot;</span> + target.getClass().getName() +</span><br><span class="line">						<span class="string">&quot;] not assignable to Editable class [&quot;</span> + editable.getName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			actualEditable = editable;</span><br><span class="line">		&#125;</span><br><span class="line">		PropertyDescriptor[] targetPds = getPropertyDescriptors(actualEditable);</span><br><span class="line">		List&lt;String&gt; ignoreList = (ignoreProperties != <span class="keyword">null</span> ? Arrays.asList(ignoreProperties) : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (PropertyDescriptor targetPd : targetPds) &#123;</span><br><span class="line">			Method writeMethod = targetPd.getWriteMethod();</span><br><span class="line">			<span class="keyword">if</span> (writeMethod != <span class="keyword">null</span> &amp;&amp; (ignoreList == <span class="keyword">null</span> || !ignoreList.contains(targetPd.getName()))) &#123;</span><br><span class="line">				PropertyDescriptor sourcePd = getPropertyDescriptor(source.getClass(), targetPd.getName());</span><br><span class="line">				<span class="keyword">if</span> (sourcePd != <span class="keyword">null</span>) &#123;</span><br><span class="line">					Method readMethod = sourcePd.getReadMethod();</span><br><span class="line">					<span class="keyword">if</span> (readMethod != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">							ClassUtils.isAssignable(writeMethod.getParameterTypes()[<span class="number">0</span>], readMethod.getReturnType())) &#123;</span><br><span class="line">						<span class="keyword">try</span> &#123;</span><br><span class="line">							<span class="keyword">if</span> (!Modifier.isPublic(readMethod.getDeclaringClass().getModifiers())) &#123;</span><br><span class="line">								readMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">							&#125;</span><br><span class="line">							Object value = readMethod.invoke(source);</span><br><span class="line">							<span class="keyword">if</span> (!Modifier.isPublic(writeMethod.getDeclaringClass().getModifiers())) &#123;</span><br><span class="line">								writeMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">							&#125;</span><br><span class="line">							writeMethod.invoke(target, value);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> FatalBeanException(</span><br><span class="line">									<span class="string">&quot;Could not copy property &#x27;&quot;</span> + targetPd.getName() + <span class="string">&quot;&#x27; from source to target&quot;</span>, ex);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到，成员变量赋值是基于目标对象的成员列表，并且会跳过ignore的以及在源对象中不存在，所以这个方法是安全的，不会因为两个对象之间的结构差异导致错误，但是<strong>必须保证同名的两个成员变量类型相同</strong></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>以上简要的分析两种BeanUtils，因为Apache下的BeanUtils性能较差，不建议使用，可以使用 Spring的BeanUtils ，或者使用其他拷贝框架，比如：**<a target="_blank" rel="noopener" href="http://dozer.sourceforge.net/documentation/gettingstarted.html">Dozer</a><strong>、</strong><a target="_blank" rel="noopener" href="http://modelmapper.org/">ModelMapper</a>**等等，在后面的文章中我会对这些拷贝框架进行介绍。</p>
<h2 id="参考资料-amp-鸣谢"><a href="#参考资料-amp-鸣谢" class="headerlink" title="参考资料 &amp; 鸣谢"></a>参考资料 &amp; 鸣谢</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.importnew.com/26306.html">谈谈 Java 开发中的对象拷贝</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000010648514">细说 Java 的深拷贝和浅拷贝</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/Performance-of-Java-Mapping-Frameworks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/Performance-of-Java-Mapping-Frameworks/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p> 本文由 JavaGuide 翻译自 <a target="_blank" rel="noopener" href="https://www.baeldung.com/java-performance-mapping-frameworks">https://www.baeldung.com/java-performance-mapping-frameworks</a> 。转载请注明原文地址以及翻译作者。</p>
</blockquote>
<h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><p>创建由多个层组成的大型 Java 应用程序需要使用多种领域模型，如持久化模型、领域模型或者所谓的 DTO。为不同的应用程序层使用多个模型将要求我们提供 bean 之间的映射方法。手动执行此操作可以快速创建大量样板代码并消耗大量时间。幸运的是，Java 有多个对象映射框架。在本教程中，我们将比较最流行的 Java 映射框架的性能。</p>
<blockquote>
<p>综合日常使用情况和相关测试数据，个人感觉 MapStruct、ModelMapper 这两个 Bean 映射框架是最佳选择。</p>
</blockquote>
<h2 id="2-常见-Bean-映射框架概览"><a href="#2-常见-Bean-映射框架概览" class="headerlink" title="2. 常见 Bean 映射框架概览"></a>2. 常见 Bean 映射框架概览</h2><h3 id="2-1-Dozer"><a href="#2-1-Dozer" class="headerlink" title="2.1. Dozer"></a>2.1. Dozer</h3><p>Dozer 是一个映射框架，它使用递归将数据从一个对象复制到另一个对象。框架不仅能够在 bean 之间复制属性，还能够在不同类型之间自动转换。</p>
<p>要使用 Dozer 框架，我们需要添加这样的依赖到我们的项目:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.dozer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dozer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更多关于 Dozer 的内容可以在官方文档中找到： <a target="_blank" rel="noopener" href="http://dozer.sourceforge.net/documentation/gettingstarted.html">http://dozer.sourceforge.net/documentation/gettingstarted.html</a> ，或者你也可以阅读这篇文章：<a target="_blank" rel="noopener" href="https://www.baeldung.com/dozer">https://www.baeldung.com/dozer</a> 。</p>
<h3 id="2-2-Orika"><a href="#2-2-Orika" class="headerlink" title="2.2. Orika"></a>2.2. Orika</h3><p>Orika 是一个 bean 到 bean 的映射框架，它递归地将数据从一个对象复制到另一个对象。</p>
<p>Orika 的工作原理与 Dozer 相似。两者之间的主要区别是 Orika 使用字节码生成。这允许以最小的开销生成更快的映射器。</p>
<p>要使用 Orika 框架，我们需要添加这样的依赖到我们的项目:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ma.glasnost.orika<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>orika-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更多关于 Orika 的内容可以在官方文档中找到：<a target="_blank" rel="noopener" href="https://orika-mapper.github.io/orika-docs/%EF%BC%8C%E6%88%96%E8%80%85%E4%BD%A0%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%98%85%E8%AF%BB%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%EF%BC%9Ahttps://www.baeldung.com/orika-mapping%E3%80%82">https://orika-mapper.github.io/orika-docs/，或者你也可以阅读这篇文章：https://www.baeldung.com/orika-mapping。</a></p>
<h3 id="2-3-MapStruct"><a href="#2-3-MapStruct" class="headerlink" title="2.3. MapStruct"></a>2.3. MapStruct</h3><p>MapStruct 是一个自动生成 bean mapper 类的代码生成器。MapStruct 还能够在不同的数据类型之间进行转换。Github 地址：<a target="_blank" rel="noopener" href="https://github.com/mapstruct/mapstruct%E3%80%82">https://github.com/mapstruct/mapstruct。</a></p>
<p>要使用 MapStruct 框架，我们需要添加这样的依赖到我们的项目:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更多关于 MapStruct 的内容可以在官方文档中找到：<a target="_blank" rel="noopener" href="https://mapstruct.org/%EF%BC%8C%E6%88%96%E8%80%85%E4%BD%A0%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%98%85%E8%AF%BB%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%EF%BC%9Ahttps://www.baeldung.com/mapstruct%E3%80%82">https://mapstruct.org/，或者你也可以阅读这篇文章：https://www.baeldung.com/mapstruct。</a></p>
<p>要使用 MapStruct 框架，我们需要添加这样的依赖到我们的项目:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-ModelMapper"><a href="#2-4-ModelMapper" class="headerlink" title="2.4. ModelMapper"></a>2.4. ModelMapper</h3><p>ModelMapper 是一个旨在简化对象映射的框架，它根据约定确定对象之间的映射方式。它提供了类型安全的和重构安全的 API。</p>
<p>更多关于 ModelMapper 的内容可以在官方文档中找到：<a target="_blank" rel="noopener" href="http://modelmapper.org/">http://modelmapper.org/</a> 。</p>
<p>要使用 ModelMapper 框架，我们需要添加这样的依赖到我们的项目:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.modelmapper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>modelmapper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-JMapper"><a href="#2-5-JMapper" class="headerlink" title="2.5. JMapper"></a>2.5. JMapper</h3><p>JMapper 是一个映射框架，旨在提供易于使用的、高性能的 Java bean 之间的映射。该框架旨在使用注释和关系映射应用 DRY 原则。该框架允许不同的配置方式:基于注释、XML 或基于 api。</p>
<p>更多关于 JMapper 的内容可以在官方文档中找到：<a target="_blank" rel="noopener" href="https://github.com/jmapper-framework/jmapper-core/wiki%E3%80%82">https://github.com/jmapper-framework/jmapper-core/wiki。</a></p>
<p>要使用 JMapper 框架，我们需要添加这样的依赖到我们的项目:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.googlecode.jmapper-framework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmapper-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-测试模型"><a href="#3-测试模型" class="headerlink" title="3.测试模型"></a>3.测试模型</h2><p>为了能够正确地测试映射，我们需要有一个源和目标模型。我们已经创建了两个测试模型。</p>
<p>第一个是一个只有一个字符串字段的简单 POJO，它允许我们在更简单的情况下比较框架，并检查如果我们使用更复杂的 bean 是否会发生任何变化。</p>
<p>简单的源模型如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceCode</span> </span>&#123;</span><br><span class="line">    String code;</span><br><span class="line">    <span class="comment">// getter and setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>它的目标也很相似:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DestinationCode</span> </span>&#123;</span><br><span class="line">    String code;</span><br><span class="line">    <span class="comment">// getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源 bean 的实际示例如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceOrder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String orderFinishDate;</span><br><span class="line">    <span class="keyword">private</span> PaymentType paymentType;</span><br><span class="line">    <span class="keyword">private</span> Discount discount;</span><br><span class="line">    <span class="keyword">private</span> DeliveryData deliveryData;</span><br><span class="line">    <span class="keyword">private</span> User orderingUser;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Product&gt; orderedProducts;</span><br><span class="line">    <span class="keyword">private</span> Shop offeringShop;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderId;</span><br><span class="line">    <span class="keyword">private</span> OrderStatus status;</span><br><span class="line">    <span class="keyword">private</span> LocalDate orderDate;</span><br><span class="line">    <span class="comment">// standard getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目标类如下图所示:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> User orderingUser;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Product&gt; orderedProducts;</span><br><span class="line">    <span class="keyword">private</span> OrderStatus orderStatus;</span><br><span class="line">    <span class="keyword">private</span> LocalDate orderDate;</span><br><span class="line">    <span class="keyword">private</span> LocalDate orderFinishDate;</span><br><span class="line">    <span class="keyword">private</span> PaymentType paymentType;</span><br><span class="line">    <span class="keyword">private</span> Discount discount;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> shopId;</span><br><span class="line">    <span class="keyword">private</span> DeliveryData deliveryData;</span><br><span class="line">    <span class="keyword">private</span> Shop offeringShop;</span><br><span class="line">    <span class="comment">// standard getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个模型结构可以在这里找到:<a target="_blank" rel="noopener" href="https://github.com/eugenp/tutorials/tree/master/performance-tests/src/main/java/com/baeldung/performancetests/model/source%E3%80%82">https://github.com/eugenp/tutorials/tree/master/performance-tests/src/main/java/com/baeldung/performancetests/model/source。</a></p>
<h2 id="4-转换器"><a href="#4-转换器" class="headerlink" title="4. 转换器"></a>4. 转换器</h2><p>为了简化测试设置的设计，我们创建了如下所示的转换器接口:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Converter</span> </span>&#123;</span><br><span class="line">    <span class="function">Order <span class="title">convert</span><span class="params">(SourceOrder sourceOrder)</span></span>;</span><br><span class="line">    <span class="function">DestinationCode <span class="title">convert</span><span class="params">(SourceCode sourceCode)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们所有的自定义映射器都将实现这个接口。</p>
<h3 id="4-1-OrikaConverter"><a href="#4-1-OrikaConverter" class="headerlink" title="4.1. OrikaConverter"></a>4.1. OrikaConverter</h3><p>Orika 支持完整的 API 实现，这大大简化了 mapper 的创建:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrikaConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MapperFacade mapperFacade;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrikaConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory</span><br><span class="line">          .Builder().build();</span><br><span class="line"></span><br><span class="line">        mapperFactory.classMap(Order.class, SourceOrder.class)</span><br><span class="line">          .field(<span class="string">&quot;orderStatus&quot;</span>, <span class="string">&quot;status&quot;</span>).byDefault().register();</span><br><span class="line">        mapperFacade = mapperFactory.getMapperFacade();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">convert</span><span class="params">(SourceOrder sourceOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mapperFacade.map(sourceOrder, Order.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DestinationCode <span class="title">convert</span><span class="params">(SourceCode sourceCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mapperFacade.map(sourceCode, DestinationCode.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-DozerConverter"><a href="#4-2-DozerConverter" class="headerlink" title="4.2. DozerConverter"></a>4.2. <strong>DozerConverter</strong></h3><p>Dozer 需要 XML 映射文件，有以下几个部分:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappings</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://dozer.sourceforge.net&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://dozer.sourceforge.net</span></span></span><br><span class="line"><span class="string"><span class="tag">  http://dozer.sourceforge.net/schema/beanmapping.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">class-a</span>&gt;</span>com.baeldung.performancetests.model.source.SourceOrder<span class="tag">&lt;/<span class="name">class-a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">class-b</span>&gt;</span>com.baeldung.performancetests.model.destination.Order<span class="tag">&lt;/<span class="name">class-b</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span>&gt;</span>status<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">b</span>&gt;</span>orderStatus<span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">class-a</span>&gt;</span>com.baeldung.performancetests.model.source.SourceCode<span class="tag">&lt;/<span class="name">class-a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">class-b</span>&gt;</span>com.baeldung.performancetests.model.destination.DestinationCode<span class="tag">&lt;/<span class="name">class-b</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>定义了 XML 映射后，我们可以从代码中使用它:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DozerConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Mapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DozerConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DozerBeanMapper mapper = <span class="keyword">new</span> DozerBeanMapper();</span><br><span class="line">        mapper.addMapping(</span><br><span class="line">          DozerConverter.class.getResourceAsStream(<span class="string">&quot;/dozer-mapping.xml&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">convert</span><span class="params">(SourceOrder sourceOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mapper.map(sourceOrder,Order.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DestinationCode <span class="title">convert</span><span class="params">(SourceCode sourceCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mapper.map(sourceCode, DestinationCode.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-MapStructConverter"><a href="#4-3-MapStructConverter" class="headerlink" title="4.3. MapStructConverter"></a>4.3. MapStructConverter</h3><p>Map 结构的定义非常简单，因为它完全基于代码生成:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MapStructConverter</span> <span class="keyword">extends</span> <span class="title">Converter</span> </span>&#123;</span><br><span class="line">    MapStructConverter MAPPER = Mappers.getMapper(MapStructConverter.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;status&quot;, target = &quot;orderStatus&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Order <span class="title">convert</span><span class="params">(SourceOrder sourceOrder)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">DestinationCode <span class="title">convert</span><span class="params">(SourceCode sourceCode)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-JMapperConverter"><a href="#4-4-JMapperConverter" class="headerlink" title="4.4. JMapperConverter"></a>4.4. <strong>JMapperConverter</strong></h3><p>JMapperConverter 需要做更多的工作。接口实现后:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMapperConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span> </span>&#123;</span><br><span class="line">    JMapper realLifeMapper;</span><br><span class="line">    JMapper simpleMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JMapperConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JMapperAPI api = <span class="keyword">new</span> JMapperAPI()</span><br><span class="line">          .add(JMapperAPI.mappedClass(Order.class));</span><br><span class="line">        realLifeMapper = <span class="keyword">new</span> JMapper(Order.class, SourceOrder.class, api);</span><br><span class="line">        JMapperAPI simpleApi = <span class="keyword">new</span> JMapperAPI()</span><br><span class="line">          .add(JMapperAPI.mappedClass(DestinationCode.class));</span><br><span class="line">        simpleMapper = <span class="keyword">new</span> JMapper(</span><br><span class="line">          DestinationCode.class, SourceCode.class, simpleApi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">convert</span><span class="params">(SourceOrder sourceOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Order) realLifeMapper.getDestination(sourceOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DestinationCode <span class="title">convert</span><span class="params">(SourceCode sourceCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (DestinationCode) simpleMapper.getDestination(sourceCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要向目标类的每个字段添加<code>@JMap</code>注释。此外，JMapper 不能在 enum 类型之间转换，它需要我们创建自定义映射函数:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JMapConversion(from = &quot;paymentType&quot;, to = &quot;paymentType&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PaymentType <span class="title">conversion</span><span class="params">(com.baeldung.performancetests.model.source.PaymentType type)</span> </span>&#123;</span><br><span class="line">    PaymentType paymentType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> CARD:</span><br><span class="line">            paymentType = PaymentType.CARD;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> CASH:</span><br><span class="line">            paymentType = PaymentType.CASH;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TRANSFER:</span><br><span class="line">            paymentType = PaymentType.TRANSFER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> paymentType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-ModelMapperConverter"><a href="#4-5-ModelMapperConverter" class="headerlink" title="4.5. ModelMapperConverter"></a>4.5. <strong>ModelMapperConverter</strong></h3><p>ModelMapperConverter 只需要提供我们想要映射的类:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelMapperConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ModelMapper modelMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ModelMapperConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        modelMapper = <span class="keyword">new</span> ModelMapper();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">convert</span><span class="params">(SourceOrder sourceOrder)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> modelMapper.map(sourceOrder, Order.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DestinationCode <span class="title">convert</span><span class="params">(SourceCode sourceCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> modelMapper.map(sourceCode, DestinationCode.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-简单的模型测试"><a href="#5-简单的模型测试" class="headerlink" title="5. 简单的模型测试"></a>5. 简单的模型测试</h2><p>对于性能测试，我们可以使用 Java Microbenchmark Harness，关于如何使用它的更多信息可以在 这篇文章：<a target="_blank" rel="noopener" href="https://www.baeldung.com/java-microbenchmark-harness">https://www.baeldung.com/java-microbenchmark-harness</a> 中找到。</p>
<p>我们为每个转换器创建了一个单独的基准测试，并将基准测试模式指定为 Mode.All。</p>
<h3 id="5-1-平均时间"><a href="#5-1-平均时间" class="headerlink" title="5.1. 平均时间"></a>5.1. 平均时间</h3><p>对于平均运行时间，JMH 返回以下结果(越少越好):</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/AVGTSimple.png" alt="AverageTime"></p>
<p>这个基准测试清楚地表明，MapStruct 和 JMapper 都有最佳的平均工作时间。</p>
<h3 id="5-2-吞吐量"><a href="#5-2-吞吐量" class="headerlink" title="5.2. 吞吐量"></a>5.2. 吞吐量</h3><p>在这种模式下，基准测试返回每秒的操作数。我们收到以下结果(越多越好):</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/THRPTRealLife2.png" alt="Throughput"></p>
<p>在吞吐量模式中，MapStruct 是测试框架中最快的，JMapper 紧随其后。</p>
<h3 id="5-3-SingleShotTime"><a href="#5-3-SingleShotTime" class="headerlink" title="5.3. SingleShotTime"></a>5.3. <strong>SingleShotTime</strong></h3><p>这种模式允许测量单个操作从开始到结束的时间。基准给出了以下结果(越少越好):</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/SSTSimple.png" alt="SingleShotTime"></p>
<p>这里，我们看到 JMapper 返回的结果比 MapStruct 好得多。</p>
<h3 id="5-4-采样时间"><a href="#5-4-采样时间" class="headerlink" title="5.4. 采样时间"></a>5.4. <strong>采样时间</strong></h3><p>这种模式允许对每个操作的时间进行采样。三个不同百分位数的结果如下:</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/SampleTimeSimple.png" alt="SampleTime"></p>
<p>所有的基准测试都表明，根据场景的不同，MapStruct 和 JMapper 都是不错的选择，尽管 MapStruct 对 SingleShotTime 给出的结果要差得多。</p>
<h2 id="6-真实模型测试"><a href="#6-真实模型测试" class="headerlink" title="6. 真实模型测试"></a>6. 真实模型测试</h2><p>对于性能测试，我们可以使用 Java Microbenchmark Harness，关于如何使用它的更多信息可以在 这篇文章：<a target="_blank" rel="noopener" href="https://www.baeldung.com/java-microbenchmark-harness">https://www.baeldung.com/java-microbenchmark-harness</a> 中找到。</p>
<p>我们为每个转换器创建了一个单独的基准测试，并将基准测试模式指定为 Mode.All。</p>
<h3 id="6-1-平均时间"><a href="#6-1-平均时间" class="headerlink" title="6.1. 平均时间"></a>6.1. 平均时间</h3><p>JMH 返回以下平均运行时间结果（越少越好）：</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/AVGTRealLife.png" alt="平均时间"></p>
<p>该基准清楚地表明，MapStruct 和 JMapper 均具有最佳的平均工作时间。</p>
<h3 id="6-2-吞吐量"><a href="#6-2-吞吐量" class="headerlink" title="6.2. 吞吐量"></a>6.2. 吞吐量</h3><p>在这种模式下，基准测试返回每秒的操作数。我们收到以下结果(越多越好):</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/THRPTRealLife.png"></p>
<p>在吞吐量模式中，MapStruct 是测试框架中最快的，JMapper 紧随其后。</p>
<h3 id="6-3-SingleShotTime"><a href="#6-3-SingleShotTime" class="headerlink" title="6.3. SingleShotTime"></a>6.3. <strong>SingleShotTime</strong></h3><p>这种模式允许测量单个操作从开始到结束的时间。基准给出了以下结果(越少越好):</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/SSTRealLife.png"></p>
<h3 id="6-4-采样时间"><a href="#6-4-采样时间" class="headerlink" title="6.4. 采样时间"></a>6.4. <strong>采样时间</strong></h3><p>这种模式允许对每个操作的时间进行采样。三个不同百分位数的结果如下:</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/SampleTimeSimple.png" alt="SampleTime"></p>
<p>尽管简单示例和实际示例的确切结果明显不同，但是它们的趋势相同。在哪种算法最快和哪种算法最慢方面，两个示例都给出了相似的结果。</p>
<h3 id="6-5-结论"><a href="#6-5-结论" class="headerlink" title="6.5. 结论"></a>6.5. 结论</h3><p>根据我们在本节中执行的真实模型测试，我们可以看出，最佳性能显然属于 MapStruct。在相同的测试中，我们看到 Dozer 始终位于结果表的底部。</p>
<h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. <strong>总结</strong></h2><p>在这篇文章中，我们已经进行了五个流行的 Java Bean 映射框架性能测试：ModelMapper <strong>，</strong> MapStruct <strong>，</strong> Orika ，Dozer， JMapper。</p>
<p>示例代码地址：<a target="_blank" rel="noopener" href="https://github.com/eugenp/tutorials/tree/master/performance-tests%E3%80%82">https://github.com/eugenp/tutorials/tree/master/performance-tests。</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/SpringBoot-ScheduleTasks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/SpringBoot-ScheduleTasks/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>很多时候我们都需要为系统建立一个定时任务来帮我们做一些事情，SpringBoot 已经帮我们实现好了一个，我们只需要直接使用即可，当然你也可以不用   SpringBoot 自带的定时任务，整合 Quartz 很多时候也是一个不错的选择。</p>
<p>本文不涉及 SpringBoot 整合 Quartz 的内容，只演示了如何使用 SpringBoot 自带的实现定时任务的方式。相关代码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/springboot-schedule-tast">https://github.com/Snailclimb/springboot-guide/tree/master/springboot-schedule-tast</a></p>
<h2 id="Spring-Schedule-实现定时任务"><a href="#Spring-Schedule-实现定时任务" class="headerlink" title="Spring Schedule 实现定时任务"></a>Spring Schedule 实现定时任务</h2><p>我们只需要 SpringBoot 项目最基本的依赖即可，所以这里就不贴配置文件了。</p>
<h3 id="1-创建一个-scheduled-task"><a href="#1-创建一个-scheduled-task" class="headerlink" title="1. 创建一个 scheduled task"></a>1. 创建一个 scheduled task</h3><p>我们使用 <code>@Scheduled</code> 注解就能很方便地创建一个定时任务，下面的代码中涵盖了 <code>@Scheduled </code>的常见用法，包括：固定速率执行、固定延迟执行、初始延迟执行、使用 Cron 表达式执行定时任务。</p>
<blockquote>
<p> Cron 表达式:  主要用于定时作业(定时任务)系统定义执行时间或执行频率的表达式，非常厉害，你可以通过 Cron 表达式进行设置定时任务每天或者每个月什么时候执行等等操作。</p>
<p>推荐一个在线Cron表达式生成器：<a target="_blank" rel="noopener" href="http://cron.qqe2.com/">http://cron.qqe2.com/</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> shuang.kou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledTasks</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ScheduledTasks.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fixedRate：固定速率执行。每5秒执行一次。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 5000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportCurrentTimeWithFixedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Current Thread : &#123;&#125;&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">        log.info(<span class="string">&quot;Fixed Rate Task : The time is now &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fixedDelay：固定延迟执行。距离上一次调用成功后2秒才执。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 2000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportCurrentTimeWithFixedDelay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            log.info(<span class="string">&quot;Fixed Delay Task : The time is now &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * initialDelay:初始延迟。任务的第一次执行将延迟5秒，然后将以5秒的固定间隔执行。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(initialDelay = 5000, fixedRate = 5000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportCurrentTimeWithInitialDelay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Fixed Rate Task with Initial Delay : The time is now &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cron：使用Cron表达式。　每分钟的1，2秒运行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;1-2 * * * * ? &quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportCurrentTimeWithCronExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Cron Expression: The time is now &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关于 fixedRate 这里其实有个坑，假如我们有这样一种情况：我们某个方法的定时器设定的固定速率是每5秒执行一次。这个方法现在要执行下面四个任务，四个任务的耗时是：6 s、6s、 2s、 3s，请问这些任务默认情况下（单线程）将如何被执行？</p>
<p>我们写一段简单的程序验证：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AsyncScheduledTasks.class);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;HH:mm:ss&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; index = Arrays.asList(<span class="number">6</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="meta">@Scheduled(fixedRate = 5000)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportCurrentTimeWithFixedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Start time is &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(index.get(i));</span><br><span class="line">            log.info(<span class="string">&quot;Fixed Rate Task : The time is now &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行程序输出如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Start time is <span class="number">20</span>:<span class="number">58</span>:<span class="number">33</span></span><br><span class="line">Fixed Rate Task : The time is now <span class="number">20</span>:<span class="number">58</span>:<span class="number">39</span></span><br><span class="line">Fixed Rate Task : The time is now <span class="number">20</span>:<span class="number">58</span>:<span class="number">45</span></span><br><span class="line">Fixed Rate Task : The time is now <span class="number">20</span>:<span class="number">58</span>:<span class="number">47</span></span><br><span class="line">Fixed Rate Task : The time is now <span class="number">20</span>:<span class="number">58</span>:<span class="number">51</span></span><br></pre></td></tr></table></figure>

<p> 看下面的运行任务示意图应该很好理解了。</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/fixdrate-single-thread.png"></p>
<p>如果我们将这个方法改为并行运行，运行结果就截然不同了。</p>
<h3 id="2-启动类上加上-EnableScheduling注解"><a href="#2-启动类上加上-EnableScheduling注解" class="headerlink" title="2. 启动类上加上@EnableScheduling注解"></a>2. 启动类上加上<code>@EnableScheduling</code>注解</h3><p>在 SpringBoot 中我们只需要在启动类上加上<code>@EnableScheduling</code>便可以启动定时任务了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-自定义线程池执行-scheduled-task"><a href="#3-自定义线程池执行-scheduled-task" class="headerlink" title="3. 自定义线程池执行 scheduled task"></a>3. 自定义线程池执行 scheduled task</h3><p>默认情况下，<code>@Scheduled</code>任务都在Spring创建的大小为1的默认线程池中执行，你可以通过在加了<code>@Scheduled</code>注解的方法里加上下面这段代码来验证。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">logger.info(<span class="string">&quot;Current Thread : &#123;&#125;&quot;</span>, Thread.currentThread().getName());</span><br></pre></td></tr></table></figure>

<p>你会发现加上上面这段代码的定时任务，每次运行都会输出：</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">Current Thread : <span class="type">scheduling</span>-<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>如果我们需要自定义线程池执行话只需要新加一个实现<code>SchedulingConfigurer</code>接口的 <code>configureTasks</code> 的类即可，这个类需要加上 <code>@Configuration</code> 注解。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerConfig</span> <span class="keyword">implements</span> <span class="title">SchedulingConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> POOL_SIZE = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureTasks</span><span class="params">(ScheduledTaskRegistrar scheduledTaskRegistrar)</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskScheduler threadPoolTaskScheduler = <span class="keyword">new</span> ThreadPoolTaskScheduler();</span><br><span class="line"></span><br><span class="line">        threadPoolTaskScheduler.setPoolSize(POOL_SIZE);</span><br><span class="line">        threadPoolTaskScheduler.setThreadNamePrefix(<span class="string">&quot;my-scheduled-task-pool-&quot;</span>);</span><br><span class="line">        threadPoolTaskScheduler.initialize();</span><br><span class="line"></span><br><span class="line">        scheduledTaskRegistrar.setTaskScheduler(threadPoolTaskScheduler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的验证的方式输出当前线程的名字会改变。</p>
<h3 id="4-EnableAsync-和-Async-使定时任务并行执行"><a href="#4-EnableAsync-和-Async-使定时任务并行执行" class="headerlink" title="4. @EnableAsync 和 @Async  使定时任务并行执行"></a>4. @EnableAsync 和 @Async  使定时任务并行执行</h3><p>如果你想要你的代码并行执行的话，还可以通过<code>@EnableAsync</code> 和 @<code>Async </code>这两个注解实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncScheduledTasks</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AsyncScheduledTasks.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fixedDelay：固定延迟执行。距离上一次调用成功后2秒才执。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//@Async</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 2000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportCurrentTimeWithFixedDelay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            log.info(<span class="string">&quot;Fixed Delay Task : The time is now &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行程序输出如下，<code>reportCurrentTimeWithFixedDelay()</code>  方法会每5秒执行一次，因为我们说过了<code>@Scheduled</code>任务都在Spring创建的大小为1的默认线程池中执行。</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">Current Thread : <span class="type">scheduling</span>-<span class="number">1</span></span><br><span class="line">Fixed <span class="keyword">Delay</span> <span class="keyword">Task</span> : <span class="type">The</span> time <span class="keyword">is</span> now <span class="number">14</span>:<span class="number">24</span>:<span class="number">23</span></span><br><span class="line">Current Thread : <span class="type">scheduling</span>-<span class="number">1</span></span><br><span class="line">Fixed <span class="keyword">Delay</span> <span class="keyword">Task</span> : <span class="type">The</span> time <span class="keyword">is</span> now <span class="number">14</span>:<span class="number">24</span>:<span class="number">28</span></span><br><span class="line">Current Thread : <span class="type">scheduling</span>-<span class="number">1</span></span><br><span class="line">Fixed <span class="keyword">Delay</span> <span class="keyword">Task</span> : <span class="type">The</span> time <span class="keyword">is</span> now <span class="number">14</span>:<span class="number">24</span>:<span class="number">33</span></span><br></pre></td></tr></table></figure>

<p><code>reportCurrentTimeWithFixedDelay()</code> 方法上加上 <code>@Async</code>   注解后输出如下，<code>reportCurrentTimeWithFixedDelay()</code>  方法会每 2 秒执行一次。</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">Current Thread : <span class="type">task</span>-<span class="number">1</span></span><br><span class="line">Fixed <span class="keyword">Delay</span> <span class="keyword">Task</span> : <span class="type">The</span> time <span class="keyword">is</span> now <span class="number">14</span>:<span class="number">27</span>:<span class="number">32</span></span><br><span class="line">Current Thread : <span class="type">task</span>-<span class="number">2</span></span><br><span class="line">Fixed <span class="keyword">Delay</span> <span class="keyword">Task</span> : <span class="type">The</span> time <span class="keyword">is</span> now <span class="number">14</span>:<span class="number">27</span>:<span class="number">34</span></span><br><span class="line">Current Thread : <span class="type">task</span>-<span class="number">3</span></span><br><span class="line">Fixed <span class="keyword">Delay</span> <span class="keyword">Task</span> : <span class="type">The</span> time <span class="keyword">is</span> now <span class="number">14</span>:<span class="number">27</span>:<span class="number">36</span></span><br></pre></td></tr></table></figure>



<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/source-code/advanced/springboot-schedule-tast">https://github.com/Snailclimb/springboot-guide/tree/master/source-code/advanced/springboot-schedule-tast</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sxl2020.github.io/2021/05/25/docs/SpringBoot/guideBro/advanced/spring-bean-validation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sxl-head.png">
      <meta itemprop="name" content="苏小乐">
      <meta itemprop="description" content="人惟患无志,有志无有不成者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏小乐の主站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/docs/SpringBoot/guideBro/advanced/spring-bean-validation/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:17:34" itemprop="dateCreated datePublished" datetime="2021-05-25T22:17:34+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>数据的校验的重要性就不用说了，即使在前端对数据进行校验的情况下，我们还是要对传入后端的数据再进行一遍校验，避免用户绕过浏览器直接通过一些 HTTP 工具直接向后端请求一些违法数据。</strong></p>
<p>本文结合自己在项目中的实际使用经验，可以说<strong>文章介绍的内容很实用，不了解的朋友可以学习一下，后面可以立马实践到项目上去。</strong></p>
<p>下面我会通过实例程序演示如何在 Java 程序中尤其是 Spring 程序中优雅地的进行参数验证。</p>
<h2 id="基础设施搭建"><a href="#基础设施搭建" class="headerlink" title="基础设施搭建"></a>基础设施搭建</h2><h3 id="相关依赖"><a href="#相关依赖" class="headerlink" title="相关依赖"></a>相关依赖</h3><p>如果开发普通 Java 程序的的话，你需要可能需要像下面这样依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.9.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.web<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 Spring Boot 程序的话只需要<code>spring-boot-starter-web</code> 就够了，它的子依赖包含了我们所需要的东西。除了这个依赖，下面的演示还用到了 lombok ，所以不要忘记添加上相关依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h3><p>下面这个是示例用到的实体类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;classId 不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String classId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Size(max = 33)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;name 不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;((^Man$|^Woman$|^UGM$))&quot;, message = &quot;sex 值不在可选范围&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;sex 不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Email(message = &quot;email 格式不正确&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;email 不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>正则表达式说明：</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><span class="line">-<span class="ruby"> ^string : 匹配以 string 开头的字符串</span></span><br><span class="line"><span class="ruby"></span>-<span class="ruby"> string<span class="variable">$ </span>：匹配以 string 结尾的字符串</span></span><br><span class="line"><span class="ruby"></span>-<span class="ruby"> ^string<span class="variable">$ </span>：精确匹配 string 字符串</span></span><br><span class="line"><span class="ruby"></span>-<span class="ruby"> ((^Man<span class="variable">$|</span>^Woman<span class="variable">$|</span>^UGM<span class="variable">$)</span>) : 值只能在 Man,Woman,UGM 这三个值中选择</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>下面这部分校验注解说明内容参考自：<a target="_blank" rel="noopener" href="https://www.cnkirito.moe/spring-validation/">https://www.cnkirito.moe/spring-validation/</a> ，感谢@<a target="_blank" rel="noopener" href="https://github.com/lexburner">徐靖峰</a>。</p>
<p><strong>JSR提供的校验注解</strong>:</p>
<ul>
<li><code>@Null</code>   被注释的元素必须为 null </li>
<li><code>@NotNull</code>    被注释的元素必须不为 null</li>
<li><code>@AssertTrue</code>     被注释的元素必须为 true </li>
<li><code>@AssertFalse</code>    被注释的元素必须为 false </li>
<li><code>@Min(value) </code>    被注释的元素必须是一个数字，其值必须大于等于指定的最小值 </li>
<li><code>@Max(value) </code>    被注释的元素必须是一个数字，其值必须小于等于指定的最大值 </li>
<li><code>@DecimalMin(value) </code> 被注释的元素必须是一个数字，其值必须大于等于指定的最小值</li>
<li><code>@DecimalMax(value)</code>  被注释的元素必须是一个数字，其值必须小于等于指定的最大值 </li>
<li><code>@Size(max=, min=) </code>  被注释的元素的大小必须在指定的范围内 </li>
<li><code>@Digits (integer, fraction) </code>    被注释的元素必须是一个数字，其值必须在可接受的范围内 </li>
<li><code>@Past </code>  被注释的元素必须是一个过去的日期 </li>
<li><code>@Future</code>     被注释的元素必须是一个将来的日期  </li>
<li><code>@Pattern(regex=,flag=) </code> 被注释的元素必须符合指定的正则表达式</li>
</ul>
<p><strong>Hibernate Validator提供的校验注解</strong>：</p>
<ul>
<li><code>@NotBlank(message =) </code>  验证字符串非null，且长度必须大于0 </li>
<li><code>@Email</code>  被注释的元素必须是电子邮箱地址 </li>
<li><code>@Length(min=,max=) </code> 被注释的字符串的大小必须在指定的范围内 </li>
<li><code>@NotEmpty </code>  被注释的字符串的必须非空 </li>
<li><code>@Range(min=,max=,message=)</code>  被注释的元素必须在合适的范围内</li>
</ul>
<h2 id="验证Controller的输入"><a href="#验证Controller的输入" class="headerlink" title="验证Controller的输入"></a>验证Controller的输入</h2><h3 id="验证请求体-RequestBody"><a href="#验证请求体-RequestBody" class="headerlink" title="验证请求体(RequestBody)"></a>验证请求体(RequestBody)</h3><p><strong>Controller：</strong></p>
<p>我们在需要验证的参数上加上了<code>@Valid</code>注解，如果验证失败，它将抛出<code>MethodArgumentNotValidException</code>。默认情况下，Spring会将此异常转换为HTTP Status 400（错误请求）。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/person&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Person&gt; <span class="title">getPerson</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> Person person)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().body(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ExceptionHandler：</strong></p>
<p>自定义异常处理器可以帮助我们捕获异常，并进行一些简单的处理。如果对于下面的处理异常的代码不太理解的话，可以查看这篇文章 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485568&idx=2&sn=c5ba880fd0c5d82e39531fa42cb036ac&chksm=cea2474bf9d5ce5dcbc6a5f6580198fdce4bc92ef577579183a729cb5d1430e4994720d59b34&token=1924773784&lang=zh_CN#rd">《SpringBoot 处理异常的几种常见姿势》</a>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice(assignableTypes = &#123;PersonController.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleValidationExceptions(</span><br><span class="line">            MethodArgumentNotValidException ex) &#123;</span><br><span class="line">        Map&lt;String, String&gt; errors = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        ex.getBindingResult().getAllErrors().forEach((error) -&gt; &#123;</span><br><span class="line">            String fieldName = ((FieldError) error).getField();</span><br><span class="line">            String errorMessage = error.getDefaultMessage();</span><br><span class="line">            errors.put(fieldName, errorMessage);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过测试验证：</strong></p>
<p>下面我通过 MockMvc 模拟请求 Controller 的方式来验证是否生效，当然你也可以通过 Postman 这种工具来验证。</p>
<p>我们试一下所有参数输入正确的情况。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_get_person_correctly</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setName(<span class="string">&quot;SnailClimb&quot;</span>);</span><br><span class="line">        person.setSex(<span class="string">&quot;Man&quot;</span>);</span><br><span class="line">        person.setClassId(<span class="string">&quot;82938390&quot;</span>);</span><br><span class="line">        person.setEmail(<span class="string">&quot;Snailclimb@qq.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        mockMvc.perform(post(<span class="string">&quot;/api/person&quot;</span>)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">                .content(objectMapper.writeValueAsString(person)))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;name&quot;</span>).value(<span class="string">&quot;SnailClimb&quot;</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;classId&quot;</span>).value(<span class="string">&quot;82938390&quot;</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;sex&quot;</span>).value(<span class="string">&quot;Man&quot;</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;email&quot;</span>).value(<span class="string">&quot;Snailclimb@qq.com&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>验证出现参数不合法的情况抛出异常并且可以正确被捕获。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_check_person_value</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       Person person = <span class="keyword">new</span> Person();</span><br><span class="line">       person.setSex(<span class="string">&quot;Man22&quot;</span>);</span><br><span class="line">       person.setClassId(<span class="string">&quot;82938390&quot;</span>);</span><br><span class="line">       person.setEmail(<span class="string">&quot;SnailClimb&quot;</span>);</span><br><span class="line"></span><br><span class="line">       mockMvc.perform(post(<span class="string">&quot;/api/person&quot;</span>)</span><br><span class="line">               .contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">               .content(objectMapper.writeValueAsString(person)))</span><br><span class="line">               .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;sex&quot;</span>).value(<span class="string">&quot;sex 值不在可选范围&quot;</span>))</span><br><span class="line">               .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;name&quot;</span>).value(<span class="string">&quot;name 不能为空&quot;</span>))</span><br><span class="line">               .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;email&quot;</span>).value(<span class="string">&quot;email 格式不正确&quot;</span>));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>使用 Postman 验证结果如下：</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-7/postman-validation.png" alt="Postman 验证结果"></p>
<h3 id="验证请求参数-Path-Variables-和-Request-Parameters"><a href="#验证请求参数-Path-Variables-和-Request-Parameters" class="headerlink" title="验证请求参数(Path Variables 和 Request Parameters)"></a>验证请求参数(Path Variables 和 Request Parameters)</h3><p><strong>Controller：</strong></p>
<p><strong>一定一定不要忘记在类上加上 <code>Validated</code> 注解了，这个参数可以告诉 Spring 去校验方法参数。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/person/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Integer&gt; <span class="title">getPersonByID</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="meta">@Max(value = 5,message = &quot;超过 id 的范围了&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().body(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/person&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">getPersonByName</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestParam(&quot;name&quot;)</span> <span class="meta">@Size(max = 6,message = &quot;超过 name 的范围了&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().body(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ExceptionHandler：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(ConstraintViolationException.class)</span></span><br><span class="line"><span class="function">ResponseEntity&lt;String&gt; <span class="title">handleConstraintViolationException</span><span class="params">(ConstraintViolationException e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(e.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过测试验证：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_check_param_value</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">      mockMvc.perform(get(<span class="string">&quot;/api/person/6&quot;</span>)</span><br><span class="line">              .contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">              .andExpect(status().isBadRequest())</span><br><span class="line">              .andExpect(content().string(<span class="string">&quot;getPersonByID.id: 超过 id 的范围了&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_check_param_value2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">      mockMvc.perform(put(<span class="string">&quot;/api/person&quot;</span>)</span><br><span class="line">              .param(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;snailclimbsnailclimb&quot;</span>)</span><br><span class="line">              .contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">              .andExpect(status().isBadRequest())</span><br><span class="line">              .andExpect(content().string(<span class="string">&quot;getPersonByName.name: 超过 name 的范围了&quot;</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="验证-Service-中的方法"><a href="#验证-Service-中的方法" class="headerlink" title="验证 Service 中的方法"></a>验证 Service 中的方法</h2><p>我们还可以验证任何Spring组件的输入，而不是验证控制器级别的输入，我们可以使用<code>@Validated</code>和<code>@Valid</code>注释的组合来实现这一需求。</p>
<p><strong>一定一定不要忘记在类上加上 <code>Validated</code> 注解了，这个参数可以告诉 Spring 去校验方法参数。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validatePerson</span><span class="params">(<span class="meta">@Valid</span> Person person)</span></span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过测试验证：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test(expected = ConstraintViolationException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_throw_exception_when_person_is_not_valid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setSex(<span class="string">&quot;Man22&quot;</span>);</span><br><span class="line">        person.setClassId(<span class="string">&quot;82938390&quot;</span>);</span><br><span class="line">        person.setEmail(<span class="string">&quot;SnailClimb&quot;</span>);</span><br><span class="line">        service.validatePerson(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Validator-编程方式手动进行参数验证"><a href="#Validator-编程方式手动进行参数验证" class="headerlink" title="Validator 编程方式手动进行参数验证"></a>Validator 编程方式手动进行参数验证</h2><p>某些场景下可能会需要我们手动校验并获得校验结果。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check_person_manually</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">    Validator validator = factory.getValidator();</span><br><span class="line">    Person person = <span class="keyword">new</span> Person();</span><br><span class="line">    person.setSex(<span class="string">&quot;Man22&quot;</span>);</span><br><span class="line">    person.setClassId(<span class="string">&quot;82938390&quot;</span>);</span><br><span class="line">    person.setEmail(<span class="string">&quot;SnailClimb&quot;</span>);</span><br><span class="line">    Set&lt;ConstraintViolation&lt;Person&gt;&gt; violations = validator.validate(person);</span><br><span class="line">    <span class="comment">//output:</span></span><br><span class="line">    <span class="comment">//email 格式不正确</span></span><br><span class="line">    <span class="comment">//name 不能为空</span></span><br><span class="line">    <span class="comment">//sex 值不在可选范围</span></span><br><span class="line">    <span class="keyword">for</span> (ConstraintViolation&lt;Person&gt; constraintViolation : violations) &#123;</span><br><span class="line">        System.out.println(constraintViolation.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面我们是通过 <code>Validator</code> 工厂类获得的 <code>Validator</code> 示例，当然你也可以通过 <code>@Autowired</code>  直接注入的方式。但是在非 Spring Component 类中使用这种方式的话，只能通过工厂类来获得 <code>Validator</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">Validator validate</span><br></pre></td></tr></table></figure>

<h2 id="自定以-Validator-实用"><a href="#自定以-Validator-实用" class="headerlink" title="自定以 Validator(实用)"></a>自定以 Validator(实用)</h2><p>如果自带的校验注解无法满足你的需求的话，你还可以自定义实现注解。</p>
<h3 id="案例一-校验特定字段的值是否在可选范围"><a href="#案例一-校验特定字段的值是否在可选范围" class="headerlink" title="案例一:校验特定字段的值是否在可选范围"></a>案例一:校验特定字段的值是否在可选范围</h3><p>比如我们现在多了这样一个需求：Person类多了一个 region 字段，region 字段只能是<code>China</code>、<code>China-Taiwan</code>、<code>China-HongKong</code>这三个中的一个。</p>
<p>第一步你需要创建一个注解：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = RegionValidator.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Region &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;Region 值不在可选范围内&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二步你需要实现 <code>ConstraintValidator</code>接口，并重写<code>isValid</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.validation.ConstraintValidator;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintValidatorContext;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegionValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">Region</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        HashSet&lt;Object&gt; regions = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        regions.add(<span class="string">&quot;China&quot;</span>);</span><br><span class="line">        regions.add(<span class="string">&quot;China-Taiwan&quot;</span>);</span><br><span class="line">        regions.add(<span class="string">&quot;China-HongKong&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> regions.contains(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在你就可以使用这个注解：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Region</span></span><br><span class="line"><span class="keyword">private</span> String region;</span><br></pre></td></tr></table></figure>

<h3 id="案例二-校验电话号码"><a href="#案例二-校验电话号码" class="headerlink" title="案例二:校验电话号码"></a>案例二:校验电话号码</h3><p>校验我们的电话号码是否合法，这个可以通过正则表达式来做，相关的正则表达式都可以在网上搜到，你甚至可以搜索到针对特定运营商电话号码段的正则表达式。</p>
<p><code>PhoneNumber.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.validation.Constraint;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.FIELD;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.PARAMETER;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.RetentionPolicy.RUNTIME;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = PhoneNumberValidator.class)</span></span><br><span class="line"><span class="meta">@Target(&#123;FIELD, PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PhoneNumber &#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;Invalid phone number&quot;</span>;</span><br><span class="line">    Class[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PhoneNumberValidator.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.validation.ConstraintValidator;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintValidatorContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneNumberValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">PhoneNumber</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String phoneField, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (phoneField == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// can be null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> phoneField.matches(<span class="string">&quot;^1(3[0-9]|4[57]|5[0-35-9]|8[0-9]|70)\\d&#123;8&#125;$&quot;</span>) &amp;&amp; phoneField.length() &gt; <span class="number">8</span> &amp;&amp; phoneField.length() &lt; <span class="number">14</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搞定，我们现在就可以使用这个注解了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PhoneNumber(message = &quot;phoneNumber 格式不正确&quot;)</span></span><br><span class="line"><span class="meta">@NotNull(message = &quot;phoneNumber 不能为空&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String phoneNumber;</span><br></pre></td></tr></table></figure>

<h2 id="使用验证组"><a href="#使用验证组" class="headerlink" title="使用验证组"></a>使用验证组</h2><p>某些场景下我们需要使用到验证组，这样说可能不太清楚，说简单点就是对对象操作的不同方法有不同的验证规则，示例如下（这个就我目前经历的项目来说使用的比较少，因为本身这个在代码层面理解起来是比较麻烦的，然后写起来也比较麻烦）。</p>
<p>先创建两个接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddPersonGroup</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeletePersonGroup</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以这样去使用验证组</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NotNull(groups = DeletePersonGroup.class)</span></span><br><span class="line"><span class="meta">@Null(groups = AddPersonGroup.class)</span></span><br><span class="line"><span class="keyword">private</span> String group;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validatePerson</span><span class="params">(<span class="meta">@Valid</span> Person person)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Validated(AddPersonGroup.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validatePersonGroupForAdd</span><span class="params">(<span class="meta">@Valid</span> Person person)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Validated(DeletePersonGroup.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validatePersonGroupForDelete</span><span class="params">(<span class="meta">@Valid</span> Person person)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过测试验证：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test(expected = ConstraintViolationException.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_check_person_with_groups</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Person person = <span class="keyword">new</span> Person();</span><br><span class="line">      person.setSex(<span class="string">&quot;Man22&quot;</span>);</span><br><span class="line">      person.setClassId(<span class="string">&quot;82938390&quot;</span>);</span><br><span class="line">      person.setEmail(<span class="string">&quot;SnailClimb&quot;</span>);</span><br><span class="line">      person.setGroup(<span class="string">&quot;group1&quot;</span>);</span><br><span class="line">      service.validatePersonGroupForAdd(person);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test(expected = ConstraintViolationException.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_check_person_with_groups2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Person person = <span class="keyword">new</span> Person();</span><br><span class="line">      person.setSex(<span class="string">&quot;Man22&quot;</span>);</span><br><span class="line">      person.setClassId(<span class="string">&quot;82938390&quot;</span>);</span><br><span class="line">      person.setEmail(<span class="string">&quot;SnailClimb&quot;</span>);</span><br><span class="line">      service.validatePersonGroupForDelete(person);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>使用验证组这种方式的时候一定要小心，这是一种反模式，还会造成代码逻辑性变差。</p>
<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/springboot-guide/tree/master/source-code/advanced/bean-validation-demo">https://github.com/Snailclimb/springboot-guide/tree/master/source-code/advanced/bean-validation-demo</a></p>
<h2 id="NotNull-vs-Column-nullable-false-重要"><a href="#NotNull-vs-Column-nullable-false-重要" class="headerlink" title="@NotNull vs @Column(nullable = false)(重要)"></a><code>@NotNull</code> vs <code>@Column(nullable = false)</code>(重要)</h2><p>在使用 JPA 操作数据的时候会经常碰到 <code>@Column(nullable = false)</code>  这种类型的约束，那么它和 <code>@NotNull</code> 有何区别呢？搞清楚这个还是很重要的！</p>
<ul>
<li><code>@NotNull</code>是 JSR 303 Bean验证批注,它与数据库约束本身无关。</li>
<li><code>@Column(nullable = false)</code> : 是JPA声明列为非空的方法。</li>
</ul>
<p>总结来说就是即前者用于验证，而后者则用于指示数据库创建表的时候对表的约束。</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul>
<li><input disabled="" type="checkbox"> 原理分析</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://reflectoring.io/bean-validation-with-spring-boot/">https://reflectoring.io/bean-validation-with-spring-boot/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnkirito.moe/spring-validation//">https://www.cnkirito.moe/spring-validation//</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/welcome/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/welcome/">1</a><span class="space">&hellip;</span><a class="page-number" href="/welcome/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/welcome/page/7/">7</a><a class="extend next" rel="next" href="/welcome/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苏小乐"
      src="/images/sxl-head.png">
  <p class="site-author-name" itemprop="name">苏小乐</p>
  <div class="site-description" itemprop="description">人惟患无志,有志无有不成者</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苏小乐</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
